const BlockLevelTags=["h1","h2","h3","h4","h5","h6","p","div","blockquote","ul","ol","li","article","section","dl","table","tbody","thead","tr","form","caption","legend","main","aside","nav","footer","header"].map(C=>C.toUpperCase()),DefaultFontAwesomeIcons=["glass","music","search","envelope","heart","star","star-empty","user","film","th-large","th","th-list","ok","remove","zoom-in","zoom-out","off","signal","cog","trash","home","file","time","road","download-alt","download","upload","inbox","play-circle","repeat","refresh","list-alt","lock","flag","headphones","volume-off","volume-down","volume-up","qrcode","barcode","tag","tags","book","bookmark","print","camera","font","bold","italic","text-height","text-width","align-left","align-center","align-right","align-justify","list","indent-left","indent-right","facetime-video","picture","pencil","map-marker","adjust","tint","edit","share","check","move","step-backward","fast-backward","backward","play","pause","stop","forward","fast-forward","step-forward","eject","chevron-left","chevron-right","plus-sign","minus-sign","remove-sign","ok-sign","question-sign","info-sign","screenshot","remove-circle","ok-circle","ban-circle","arrow-left","arrow-right","arrow-up","arrow-down","share-alt","resize-full","resize-small","plus","minus","asterisk","exclamation-sign","gift","leaf","fire","eye-open","eye-close","warning-sign","plane","calendar","random","comment","magnet","chevron-up","chevron-down","retweet","shopping-cart","folder-close","folder-open","resize-vertical","resize-horizontal","bar-chart","twitter-sign","facebook-sign","camera-retro","key","cogs","comments","thumbs-up","thumbs-down","star-half","heart-empty","signout","linkedin-sign","pushpin","external-link","signin","trophy","github-sign","upload-alt","lemon","phone","check-empty","bookmark-empty","phone-sign","twitter","facebook","github","unlock","credit-card","rss","hdd","bullhorn","bell","certificate","hand-right","hand-left","hand-up","hand-down","circle-arrow-left","circle-arrow-right","circle-arrow-up","circle-arrow-down","globe","wrench","tasks","filter","briefcase","fullscreen","group","link","cloud","beaker","cut","copy","paper-clip","save","sign-blank","reorder","list-ul","list-ol","strikethrough","underline","table","magic","truck","pinterest","pinterest-sign","google-plus-sign","google-plus","money","caret-down","caret-up","caret-left","caret-right","columns","sort","sort-down","sort-up","envelope-alt","linkedin","undo","legal","dashboard","comment-alt","comments-alt","bolt","sitemap","umbrella","paste","lightbulb","exchange","cloud-download","cloud-upload","user-md","stethoscope","suitcase","bell-alt","coffee","food","file-alt","building","hospital","ambulance","medkit","fighter-jet","beer","h-sign","plus-sign-alt","double-angle-left","double-angle-right","double-angle-up","double-angle-down","angle-left","angle-right","angle-up","angle-down","desktop","laptop","tablet","mobile-phone","circle-blank","quote-left","quote-right","spinner","circle","reply"],AvailableColors=["red","green","blue","yellow","gold","white","silver","gray","dark","black"],ColorHeadMarkReg=new RegExp("\\[("+AvailableColors.join("|")+")\\]"),ColorTailMark="[/]",QuoteTypes=["quote","info","success","warning","danger"],HeaderLevel={"=":6,"-":5,"+":4,_:4,"*":3,"#":2,".":1},MenuConfig=[[{name:"\u4FDD\u5B58",icon:"save",action:"save-article",shortcut:"ctrl+S"},"line",{name:"\u4E0B\u8F7D",icon:"download",action:"download-file",shortcut:"ctrl+alt+S"},{name:"\u6253\u5F00\u672C\u5730\u6587\u6863",icon:"upload",action:"upload-file",shortcut:"ctrl+alt+O"},"line",{name:"\u65B0\u5EFA\u7A7A\u6587\u6863",icon:"file",action:"NewFile",shortcut:"ctrl+N"}],"line",[{name:"\u52A0\u7C97",icon:"bold",action:"bold",shortcut:"ctrl+B"},{name:"\u659C\u4F53",icon:"italic",action:"italic",shortcut:"ctrl+I"},{name:"\u4E0B\u5212\u7EBF",icon:"underline",action:"underline",shortcut:"alt+U"},{name:"\u6CE2\u6D6A\u7EBF",icon:"water",action:"wavy",shortcut:"alt+W"},{name:"\u5220\u9664\u7EBF",icon:"strikethrough",action:"throughLine",shortcut:"alt+D"},"line",[{name:"\u7EA2\u8272",icon:"color red",action:"red"},{name:"\u7EFF\u8272",icon:"color green",action:"green"},{name:"\u84DD\u8272",icon:"color blue",action:"blue"},{name:"\u9EC4\u8272",icon:"color yellow",action:"yellow"},{name:"\u91D1\u8272",icon:"color gold",action:"gold"},{name:"\u767D\u8272",icon:"color white",action:"white"},{name:"\u94F6\u8272",icon:"color silver",action:"silver"},{name:"\u7070\u8272",icon:"color gray",action:"gray"},{name:"\u6DF1\u8272",icon:"color dark",action:"dark"},{name:"\u9ED1\u8272",icon:"color black",action:"black"}],"line",{name:"\u4E0A\u6807",icon:"superscript",action:"sup",shortcut:"alt+P"},{name:"\u4E0B\u6807",icon:"subscript",action:"sub",shortcut:"alt+B"},"line",{name:"\u5927\u4E00\u53F7",icon:"sort-amount-up",action:"sizeUp",shortcut:"ctrl+Up"},{name:"\u5C0F\u4E00\u53F7",icon:"sort-amount-down",action:"sizeDown",shortcut:"ctrl+Down"}],[{name:"\u811A\u6CE8",icon:"paragraph",action:"footnote",shortcut:"alt+F"},{name:"\u5C3E\u6CE8",icon:"scroll",action:"endnote",shortcut:"alt+E"},{name:"\u672F\u8BED",icon:"pen-nib",action:"term",shortcut:"alt+T"},{name:"\u951A\u70B9",icon:"map-pin",action:"anchor",shortcut:"alt+A"},"line",{name:"\u884C\u5185\u4EE3\u7801",icon:"code",action:"convert-code",shortcut:"alt+C"},{name:"\u884C\u5185\u516C\u5F0F",icon:"square-root-alt",action:"convert-latex",shortcut:"alt+L"},"line",{name:"\u63D2\u5165\u56FE\u6807",icon:"flag",action:"insert-icon"}],"line",[[{name:"\u4E00\u7EA7\u6807\u9898",icon:"heading one",action:"heading-1",shortcut:"alt+H"},{name:"\u4E8C\u7EA7\u6807\u9898",icon:"heading two",action:"heading-2"},{name:"\u4E09\u7EA7\u6807\u9898",icon:"heading three",action:"heading-3"},{name:"\u56DB\u7EA7\u6807\u9898",icon:"heading four",action:"heading-4"},{name:"\u4E94\u7EA7\u6807\u9898",icon:"heading five",action:"heading-5"},{name:"\u516D\u7EA7\u6807\u9898",icon:"heading six",action:"heading-6"}],"line",[{name:"\u666E\u901A\u5F15\u7528",icon:"quote-right",action:"quote-quote"},{name:"\u4FE1\u606F\u5F15\u7528",icon:"quote-left",action:"quote-info"},{name:"\u63D0\u9192\u5F15\u7528",icon:"angle-double-right font green",action:"quote-success"},{name:"\u8B66\u544A\u5F15\u7528",icon:"angle-right",action:"quote-warning"},{name:"\u62A5\u9519\u5F15\u7528",icon:"angle-double-right font red",action:"quote-danger"}],[{name:"\u65E0\u5E8F\u5217\u8868",icon:"list-ul",action:"list-ul"},{name:"\u6709\u5E8F\u5217\u8868",icon:"list-ol",action:"list-ol"}],{name:"\u8868\u683C",icon:"table",action:"insert-table"},"line",{name:"\u4EE3\u7801",icon:"code",action:"insert-code",shortcut:"ctrl+alt+C"},{name:"\u516C\u5F0F",icon:"square-root-alt",action:"insert-latex",shortcut:"ctrl+alt+L"}],[{name:"\u5C42\u8FDB",icon:"indent",action:"TabIndent"},{name:"\u5C42\u51FA",icon:"outdent",action:"TabOutdent"},"line",{name:"\u5DE6\u5BF9\u9F50",icon:"align-left",action:"align-left"},{name:"\u5C45\u4E2D",icon:"align-center",action:"align-center"},{name:"\u53F3\u5BF9\u9F50",icon:"align-right",action:"align-right"},"line",{name:"\u7F29\u8FDB",icon:"indent font blue",action:"indent",shortcut:"ctrl+alt+Right"},{name:"\u9000\u51FA",icon:"outdent font blue",action:"outdent",shortcut:"ctrl+alt+Left"}],"line",[{name:"\u63D2\u5165\u8D85\u94FE\u63A5",icon:"link",action:"insert-link",shortcut:"alt+K"},{name:"\u63D2\u5165\u56FE\u7247",icon:"image",action:"insert-image"},{name:"\u63D2\u5165\u89C6\u9891",icon:"video",action:"insert-video"},{name:"\u63D2\u5165\u97F3\u9891",icon:"music",action:"insert-audio"}],[{name:"\u666E\u901A\u5206\u9694\u7EBF",icon:"minus",action:"headline-normal"},{name:"\u53CC\u5C42\u5206\u9694\u7EBF",icon:"grip-lines",action:"headline-double"},{name:"\u865A\u7EBF",icon:"ellipsis-h",action:"headline-dotted"},{name:"\u70B9\u5212\u7EBF",icon:"window-minimize",action:"headline-dashed"},{name:"\u6E10\u53D8\u7EBF",icon:"icicles",action:"headline-gradient"},{name:"\u4EA4\u53C9\u7EBF",icon:"grip-horizontal",action:"headline-wavy"},{name:"\u5708\u9694\u7EBF",icon:"genderless",action:"headline-star"}],"line",{name:"\u63D2\u5165\u5F15\u7528\u5757",icon:"vector-square",action:"insert-block"},"line",{name:"\u9884\u89C8",icon:"eye",action:"preview"},"line",{name:"\u5E2E\u52A9\u6587\u6863",icon:"info-circle",action:"help",shortcut:"ctrl+H"},"line",{name:"\u5173\u95ED\u672C\u6587\u6863",icon:"times-circle",action:"close"}],Shortcuts={Enter:"Enter",Tab:"TabIndent","shift+Tab":"TabOutdent","ctrl+Tab":"TabOutdent","ctrl+alt+Up":"BlockUp","ctrl+alt+Down":"BlockDown","ctrl+shift+Up":"BlockUp","ctrl+shift+Down":"BlockDown","ctrl+Z":"Undo","ctrl+Y":"Redo"},newID=(C=32)=>{var t=[];for(let e=0;e<C;e++)t.push(Math.floor(Math.random()*36).toString(36));return t.join("")};class MenuItem{constructor(t,e,n,r){r=r?r.trim():"",r&&(t=t+"\uFF08"+r+"\uFF09"),this.key=n||e,this.name=t,this.icon=e,this.shortcut=r,this.ui=newEle("div","menu-item"),this.ui.innerHTML='<i class="fa fas far fab fa-'+e+'"></i><span class="menu-item-hint">'+t+"</span>",this.container=null,this.ui.addEventListener("click",()=>{!this.container||this.container.onClick(this.key,this)})}update(t,e,n){var r=this.ui.querySelector("i.fa");r.className="fa fas far fab fa-"+e,this.ui.querySelector("span.menu-item-hint").innerHTML=t,this.key=n,this.name=t,this.icon=e}getShortcuts(){var t={};return this.shortcut&&(t[this.shortcut]=this.key),t}}class MenuLine extends MenuItem{constructor(){super();this.ui=newEle("div","menu-break-line")}}class MenuGroup{constructor(t){this.items=[],this.name="",this.icon="",this.key="",this.container,this.btn=new MenuItem("","",""),this.btn.container=this,this.group=newEle("div","menu-group-area"),this.ui=newEle("div","menu-group"),this.ui.appendChild(this.btn.ui),this.ui.appendChild(this.group),t.forEach(e=>{if(e==="line")this.add(new MenuLine);else if(Array.is(e))this.add(new MenuGroup(e));else if(!!e.name&&!!e.action){let n=[e.name,e.icon||e.action,e.action];e.shortcut&&n.push(e.shortcut),this.add(...n)}})}add(t,e,n,r){if(t instanceof MenuItem)t.container=this,this.items.push(t),this.group.appendChild(t.ui);else if(t instanceof MenuGroup)t.ui.classList.add("menu-subgroup"),t.container=this,this.items.push(t),this.group.appendChild(t.ui);else{let s=new MenuItem(t,e,n,r);s.container=this,this.items.push(s),this.group.appendChild(s.ui)}if(this.items.length===1){let s=this.items[0];this.btn.update(s.name,s.icon,s.key),this.name=s.name,this.icon=s.icon,this.key=s.key}}onClick(t,e){this.btn.update(e.name,e.icon,e.key),this.name=e.name,this.icon=e.icon,this.key=e.key,!!this.container&&this.container.onClick(t,e)}getShortcuts(){var t={};return this.items.forEach(e=>{e=e.getShortcuts(),Object.keys(e).forEach(n=>{n&&(t[n]=e[n])})}),t}}class MenuBar{constructor(t,e){this.items=[],this.ui=newEle("div","menu-bar"),this.hooker=e,t.forEach(n=>{if(n==="line")this.add(new MenuLine);else if(Array.is(n))this.add(new MenuGroup(n));else if(!!n.name&&!!n.action){let r=[n.name,n.icon||n.action,n.action];n.shortcut&&r.push(n.shortcut),this.add(...r)}})}add(t,e,n,r){if(t instanceof MenuItem)t.ui.classList.add("top-level"),this.items.push(t),this.ui.appendChild(t.ui),t.container=this;else if(t instanceof MenuGroup)this.items.push(t),this.ui.appendChild(t.ui),t.container=this;else{let s=new MenuItem(t,e,n,r);s.ui.classList.add("top-level"),this.items.push(s),this.ui.appendChild(s.ui),s.container=this}}onClick(t,e){!this.hooker||this.hooker(t)}getShortcuts(){var t={};return this.items.forEach(e=>{e=e.getShortcuts(),Object.keys(e).forEach(n=>{n&&(t[n]=e[n])})}),t}}class HistoryManager{constructor(){this.index=-1,this.memory=[]}reset(t=null){this.memory.splice(0,this.memory.length),t===null?this.index=-1:(this.index=0,this.memory[0]=[t,0,0,0,0])}add(t,e,n,r,s){this.index++,this.memory.splice(this.index,this.memory.length),this.memory[this.index]=[t,e,n,r,s]}undo(){if(!(this.index<=0))return this.index--,this.memory[this.index]}redo(){if(!(this.index>=this.memory.length-1))return this.index++,this.memory[this.index]}}class Editor extends EventEmitter{constructor(t){super();if(!!t.ui?.editor){if(this.Toolbar=null,this.MenuBar=null,this.Shortcuts=new Map,this.ActionHandlers=new Map,this.Memory=new HistoryManager,this.LineHeadPrefix=/^[ 　\t]+/,this.imeOn=!1,this.lastContent="",this.contentChanged=!1,this.tmrChanger=null,this.lastRange=null,this.Editor=String.is(t.ui.editor)?document.querySelector(t.ui.editor):t.ui.editor,document.execCommand("defaultParagraphSeparator",!1,"p"),document.execCommand("insertbronreturn",!1,!1),this.Editor.addEventListener("keydown",e=>this.onKeyDown(e)),this.Editor.addEventListener("keyup",e=>this.onKeyUp(e)),this.Editor.addEventListener("compositionstart",e=>this.onIMEStart(e)),this.Editor.addEventListener("compositionend",e=>this.onIMEEnd(e)),this.Editor.addEventListener("drop",e=>this.onDrop(e)),this.Editor.addEventListener("copy",e=>this.onCopy(e)),this.Editor.addEventListener("cut",e=>this.onCut(e)),this.Editor.addEventListener("paste",e=>this.onPaste(e)),this.Editor.addEventListener("blur",e=>this.onBlur(e)),this.Editor.parentElement.addEventListener("mousewheel",e=>this.onWheel(e)),this.Editor.parentElement.addEventListener("scroll",e=>this.onWheel(e)),this.Editor.innerText===""&&this.clear(),this.WordCountHint=String.is(t.ui.wordcount)?document.querySelector(t.ui.wordcount):t.ui.wordcount,this.WordCountHint.innerText=0,t.ui?.toolbar){this.Toolbar=String.is(t.ui.toolbar)?document.querySelector(t.ui.toolbar):t.ui.toolbar,this.MenuBar=new MenuBar(t.toolbar,(...n)=>this.actionHandler(...n)),this.Toolbar.appendChild(this.MenuBar.ui);let e=this.MenuBar.getShortcuts();Object.keys(e).forEach(n=>this.addShortcut(n,e[n]))}if(t.shortcuts)for(let e in t.shortcuts)this.addShortcut(e,t.shortcuts[e]);this.addHandler("TabIndent",(e,n,r)=>this.blockIndent(e,!0)),this.addHandler("TabOutdent",(e,n,r)=>this.blockIndent(e,!1)),this.addHandler("BlockUp",(e,n,r)=>this.moveBlock(e,!0)),this.addHandler("BlockDown",(e,n,r)=>this.moveBlock(e,!1)),this.addHandler("Enter",(e,n,r)=>this.insertNewLine()),this.addHandler("Undo",(e,n,r)=>this.recallMemory(!0)),this.addHandler("Redo",(e,n,r)=>this.recallMemory(!1)),this.addHandler("NewFile",(e,n,r)=>(this.newFile(),!0));for(let e in t.callback)this.addHandler(e,t.callback[e])}}clear(){this.Memory.reset(""),this.lastContent="",this.contentChanged=!1,this.initialBlankContent(!0)}read(t){this.Memory.reset(t),this.lastContent=t,this.contentChanged=!1;var e=document.createDocumentFragment();e.appendChild(newEle("div"));var n=e.firstChild;t.split(`
`).forEach((r,s)=>{var i=newEle("p");r.length===0?i.innerHTML="<br>":i.innerText=r,n.appendChild(i)}),this.Editor.innerHTML=n.innerHTML,this.requestContentUpdate(!0,!1),this.actionHandler("ContentUpdated",!1,t)}newFile(){this.clear(),this.actionHandler("ContentUpdated",!1,"")}addShortcut(t,e){this.Shortcuts.set(t,e)}addHandler(t,e){this.ActionHandlers.set(t,e)}actionHandler(t,e=!1,...n){e||this.restoreRange();var r=this.ActionHandlers.get(t);if(!!r)return r(this,e,...n)}initialBlankContent(t=!1){this.Editor.innerHTML="<p><br/></p>",t&&this.Editor.querySelector("p").focus()}getLines(){return[].filter.call(this.Editor.children,t=>{if(t.tagName==="P")return!0})}getContent(){var t=[];for(let n of this.Editor.childNodes)if(!(!n.tagName&&n.nodeName!=="#text")){var e="";n.tagName!=="BR"&&(e=n.textContent||n.innerText),e!=null&&t.push(e.replace(/\n+/,""))}return t=t.join(`
`),t}optimizeContent(){var t=document.getSelection(),e=t.getRangeAt(0);if(!e)return[null,0,null,0,0,0];var n,r;if(e.collapsed)n="[["+newID()+"|OMNI]]",r=null,Editor.insertHTML(n);else{n="[["+newID()+"|START]]",r="[["+newID()+"|END]]";let m=document.createRange();m.setStart(e.endContainer,e.endOffset),m.setEnd(e.endContainer,e.endOffset),t.removeAllRanges(),t.addRange(m),Editor.insertHTML(r),m.setStart(e.startContainer,e.startOffset),m.setEnd(e.startContainer,e.startOffset),t.removeAllRanges(),t.addRange(m),Editor.insertHTML(n)}var s=document.createDocumentFragment();s.appendChild(newEle("div"));var i=s.firstChild,a=-1,o=-1,l=-1,d=-1,h=[];for(let m of this.Editor.childNodes)if(!(!m.tagName&&m.nodeName!=="#text")){var c="";m.tagName!=="BR"&&(c=m.textContent||m.innerText),c!=null&&h.push(c.replace(/\n+/,""))}h.forEach((m,b)=>{var E=newEle("p");if(m.length===0)E.innerHTML="<br>";else{E.innerText=m;let x=m.indexOf(n);x>=0&&(a=b,l=x),r&&(x=m.indexOf(r),x>=0&&(o=b,d=x))}i.appendChild(E)}),this.Editor.innerHTML!==i.innerHTML&&(this.Editor.innerHTML=i.innerHTML);var u=null,g=null,v=this.Editor.children;if(r)if(a>=0&&o>=a)u=v.item(a),g=v.item(o),u.innerText=u.textContent.replace(n,""),u.innerText===""&&(u.innerHTML="<br>"),g.innerText=g.innerText.replace(r,""),g.innerText===""&&(g.innerHTML="<br>"),a===o&&(d-=n.length);else return[null,0,null,0,0,0];else if(a>=0)u=v.item(a),u.innerText=u.textContent.replace(n,""),u.innerText===""&&(u.innerHTML="<br>"),g=u,d=l;else return[null,0,null,0,0,0];var f=u.childNodes.item(0),p=g.childNodes.item(0);try{e.setStart(f,l),e.setEnd(p,d),t.removeAllRanges(),t.addRange(e)}catch(m){return[u,0,g,0,a,o]}return[u,l,g,d,a,o]}onKeyDown(t){if(!this.imeOn&&![16,17,18,91].includes(t.which)){if(this.Editor.children.length===0&&this.initialBlankContent(!0),t.which===13){this.onEnter(t);return}var e=Editor.getKeyPair(t);this.Shortcuts.has(e)&&t.preventDefault()}}onKeyUp(t){if(!this.imeOn&&![16,17,18,91].includes(t.which)){var e=Editor.getKeyPair(t),n=this.Shortcuts.get(e);if(n&&this.actionHandler(n,!0)){t.preventDefault();return}["ESC","Up","Down","Left","Right"].indexOf(e)<0&&(this.contentChanged=!0,this.requestContentUpdate())}}onIMEStart(t){this.imeOn=!0}onIMEEnd(t){this.imeOn=!1}onDrop(t){this.actionHandler("Drop",!0,t)&&(this.contentChanged=!0,this.requestContentUpdate(),t.preventDefault())}onCopy(t){var e=document.getSelection(),n=e.getRangeAt(0);if(!!n.collapsed){var r=Editor.getLineOfNode(n.startContainer),s=document.createRange();s.selectNode(r);var i=document.getSelection();i.removeAllRanges(),i.addRange(s)}}onCut(t){var e=document.getSelection(),n=e.getRangeAt(0);if(!!n.collapsed){var r=Editor.getLineOfNode(n.startContainer),s=document.createRange();s.selectNode(r);var i=document.getSelection();i.removeAllRanges(),i.addRange(s)}}onPaste(t){var e=!!this.actionHandler("Paste",!0,t);if(e){t.preventDefault();return}var n=!1,r=[],s=t.clipboardData.getData("text/html")||t.clipboardData.getData("text/plain")||t.clipboardData.getData("text");if(s.substr(0,1)==="<"){let i=new DocumentFragment;i.appendChild(newEle("div")),i.firstChild.innerHTML=s.replace(/\n+/g,""),[n,r]=Editor.getFragmentLines(i.firstChild)}else r=s.split(`
`);this.insertBlock(r,!0,!0,!1),t.preventDefault()}onEnter(t){if(t.ctrlKey||t.altKey||t.shiftKey||t.metaKey){t.preventDefault();return}}onEdited(t=!0){if(!this.imeOn&&(this.tmrChanger&&clearTimeout(this.tmrChanger),this.tmrChanger=null,!!this.contentChanged)){var[e,n,r,s]=this.optimizeContent(),i=this.getContent();if(i!==this.lastContent&&(this.lastContent=i,this.contentChanged=!1,this.actionHandler("ContentUpdated",!1,i),!!t)){var a=this.getLines();e=a.indexOf(e),r=a.indexOf(r),this.Memory.add(i,e,n,r,s)}}}onBlur(t){var e=document.getSelection();this.lastRange=e.getRangeAt(0)}onWheel(t){this.actionHandler("Scroll",!0,t)}recallMemory(t=!0){this.requestContentUpdate(!0,!0);var e=t?this.Memory.undo():this.Memory.redo();if(!e)return!0;var[n,r,s,i,a]=e,o=document.createDocumentFragment();o.appendChild(newEle("div"));var l=o.firstChild;if(n.split(`
`).forEach((c,u)=>{var g=newEle("p");c.length===0?g.innerHTML="<br>":g.innerText=c,l.appendChild(g)}),this.Editor.innerHTML=l.innerHTML,r=this.Editor.children.item(r),!r||(r=r.childNodes.item(0),!r)||(i=this.Editor.children.item(i),!i)||(i=i.childNodes.item(0),!i))return!0;var d=document.getSelection(),h=document.createRange();return h.setStart(r,s),h.setEnd(i,a),d.removeAllRanges(),d.addRange(h),this.requestContentUpdate(!0,!1),!0}requestContentUpdate(t=!1,e=!0){this.tmrChanger&&clearTimeout(this.tmrChanger),t?(this.tmrChanger=null,this.onEdited(e)):this.tmrChanger=setTimeout(()=>this.onEdited(e),1e3)}blockIndent(t,e=!0){var[n,r,s,i]=this.optimizeContent(),a=n===s&&r===i;if(a)if(e)Editor.insertHTML("	");else{let o=n.innerText,l=o.substring(0,r),d=o.substring(r,o.length);if(l.substring(l.length-1,l.length)==="	"){l=l.substring(0,l.length-1),o=l+d,n.innerText=o;let c=document.getSelection(),u=document.createRange();n=n.childNodes.item(0),u.setStart(n,r-1),u.setEnd(n,r-1),c.removeAllRanges(),c.addRange(u)}}else{let o=!1;this.getLines().forEach(h=>{if(h===n&&(o=!0),!o)return;let c=h.childNodes.item(0);if(!!c&&c.tagName!=="BR"){let u=h.innerText;e?u="	"+u:u=u.replace(/^\t/,""),h.innerText=u}h===s&&(o=!1)}),n=n.childNodes.item(0),s=s.childNodes.item(0);let l=document.getSelection(),d=document.createRange();d.setStart(n,0),d.setEnd(s,(s.textContent||"").length),l.removeAllRanges(),l.addRange(d)}return this.requestContentUpdate(!0,!0),!0}moveBlock(t,e=!0){var[n,r,s,i]=this.optimizeContent(),a=this.getLines(),o=a.indexOf(n),l=a.indexOf(s);if(o<0||l<0||o===0&&e||l===a.length-1&&!e)return!1;var d,h;if(e){if(d=a[o-1],!d)return!1;h=a[l+1],h?this.Editor.insertBefore(d,h):this.Editor.appendChild(d)}else{if(d=a[l+1],!d)return!1;h=a[o],this.Editor.insertBefore(d,h)}n=n.childNodes.item(0),s=s.childNodes.item(0);var c=document.getSelection(),u=document.createRange();return u.setStart(n,0),u.setEnd(s,(s.textContent||"").length),c.removeAllRanges(),c.addRange(u),this.requestContentUpdate(!0,!0),!0}insertNewLine(){var[t,e,n,r]=this.optimizeContent();if(!(!t||!n)){var s=document.getSelection(),i=s.getRangeAt(0),a=t.previousSibling;if(!!a){var o=a.textContent.replace(/^\n+|\n+$/g,""),l=o.match(this.LineHeadPrefix);if(!(!l||l[0].length===0)){if(l=l[0],o===l)this.Editor.removeChild(a),i.setStart(t,0),i.setEnd(t,0);else{let d=t.textContent.replace(/^\n+|\n+$/g,"");t.innerText=l+d,t=t.childNodes.item(0),i.setStart(t,l.length),i.setEnd(t,l.length)}return s.removeAllRanges(),s.addRange(i),this.requestContentUpdate(!0,!0),!0}}}}insertBlock(t,e,n,r,s,i,a,o){s||([s,i,a,o]=this.optimizeContent());var l=a.textContent;l=l.substring(o);var d=s.textContent.substring(0,i);e?(t[0]=d+t[0],o=t[t.length-1].length,t[t.length-1]=t[t.length-1]+l,d="",l=""):(d.length===0?s.innerHTML="<br>":s.innerText=d,i=0);var h=this.getLines(),c=h.indexOf(s),u=h.indexOf(a);for(let p=c+1;p<=u;p++)this.Editor.removeChild(h[p]);var g=a.nextElementSibling;if(e&&(g=s),!g)g=newEle("p"),l.length===0?g.innerHTML="<br>":g.innerText=l,this.Editor.appendChild(g);else if(!e){let p=newEle("p");l.length===0?p.innerHTML="<br>":p.innerText=l,this.Editor.insertBefore(p,g),g=p}e||(l=newEle("p"),l.innerHTLM="<br>",this.Editor.insertBefore(l,g)),String.is(t)&&(t=[t]),t.forEach((p,m)=>{var b=newEle("p");p.length===0?b.innerHTML="<br>":b.innerText=p,this.Editor.insertBefore(b,g),m===0&&(d=b),a=b}),e?this.Editor.removeChild(s):(l=newEle("p"),l.innerHTLM="<br>",this.Editor.insertBefore(l,g));var v=document.getSelection(),f=document.createRange();return s=d.childNodes.item(0),a=a.childNodes.item(0),e||(o=a.textContent.length),r?f.setStart(s,i):f.setStart(a,o),f.setEnd(a,o),v.removeAllRanges(),v.addRange(f),n&&(this.contentChanged=!0,this.requestContentUpdate(!0)),!0}restoreRange(){if(!!this.lastRange){var t=document.getSelection();try{t.removeAllRanges(),t.addRange(this.lastRange)}catch(e){}this.lastRange=null}}static insertHTML(t){document.execCommand("insertHTML",!1,t)}static getLineOfNode(t){if(t.tagName==="P")return t;var e=document.body;for(t=t.parentElement;t&&t.tagName!=="P";){if(t===e){t=null;break}t=t.parentElement}return t}static getLinePosition(t,e,n=0){if(!t.childNodes)return n;var r=0;for(let s of t.childNodes){if(s===e)return r+=n,[!0,r];if(s.nodeName==="#text")r+=s.textContent.length;else{let[i,a]=Editor.getLinePosition(s,e,n);if(r+=a,i)return[!0,r]}}return[!1,r]}static getKeyPair(t){var e=[];t.ctrlKey&&e.push("ctrl"),t.altKey&&e.push("alt"),t.shiftKey&&e.push("shift"),t.winKey&&e.push("win"),t.metaKey&&e.push("meta");var n=t.key;return n.indexOf("Arrow")>=0?n=n.replace("Arrow",""):t.which===27?n="Esc":t.which===8?n="Back":t.which===9?n="Tab":t.which===13?n="Enter":n=n.toUpperCase(),e.push(n),e=e.join("+"),e}static getFragmentLines(t){var e=[],n=[],r=!1;for(let i of t.childNodes){let a=i.nodeName;if(a==="#text"){let o=i.textContent;if(o=o.replace(/^\n+|\n+$/g,""),o.length===0)continue;o=o.split(`
`),o.forEach((l,d)=>{n.push(l),d<o.length-1&&n.length>0&&(e.push(n),n=[])})}else{if(a.indexOf("#")>=0)continue;if(a==="STYLE"||a==="SCRIPT")continue;if(a==="BR")e.push(n),n=[];else if(BlockLevelTags.indexOf(a)>=0){r=!0,n.length>0&&e.push(n);let o=!i.classList.contains("newline");o&&e.push([]),n=[],Editor.getFragmentLines(i)[1].forEach(l=>e.push(l)),o&&e.push([])}else n.push(i.innerText)}}n.length>0&&e.push(n),e=e.map(i=>Array.is(i)?i.join(""):i);var s=!1;return e=e.filter(i=>(i=i||"",i.length>0?(s=!1,!0):s?!1:(s=!0,!0))),[r,e]}}class MarkupEditor extends Editor{constructor(t){super(t);this.LineHeadPrefix=/^([ 　\t>\+\*~]|\d+\.[ 　\t]+|\-[ 　\t]+)+/,this.title="untitled",this.filename="",this.lineMap=[],this.tmrScroll=null,this.notAutoUpdateContent=!1,this.Preview=String.is(t.ui.preview)?document.querySelector(t.ui.preview):t.ui.preview,this.addHandler("ContentUpdated",(e,n,r)=>{if(this.notAutoUpdateContent)return!0;r=r.split(`
`);var s=!1,i="";return this.lineMap.splice(0,this.lineMap.length),r=r.map((a,o)=>{var l=!1;if([l,s,i]=MarkupEditor.notTextLine(a,s,i),l)return a;var d=a.match(/^([ 　`~!@#%^&\*\-_\+=\\\|:;\/\?\.,<>\d\r\t]|(\[\w*\][ 　\t]*(\(.*\))*)|\{[\|<>]*\})*/);d?d=d[0]:d="";var h=a.substring(0,d.length),c=a.substring(d.length,a.length);return d="%LINENUMBER-"+o+"%",this.lineMap.push(o),h+d+c}),r=r.join(`
`),this.markupDoc(r),!0}),this.addHandler("Scroll",e=>{this.tmrScroll&&clearTimeout(this.tmrScroll),this.tmrScroll=setTimeout(()=>this.onScrolled(),100)}),this.addHandler("bold",e=>this.togglePair("**")),this.addHandler("italic",e=>this.togglePair("*")),this.addHandler("underline",e=>this.togglePair("__")),this.addHandler("wavy",e=>this.togglePair("~")),this.addHandler("throughLine",e=>this.togglePair("~~")),this.addHandler("sub",e=>this.togglePair("_")),this.addHandler("sup",e=>this.togglePair("^")),this.addHandler("red",e=>this.changeColor("red")),this.addHandler("green",e=>this.changeColor("green")),this.addHandler("blue",e=>this.changeColor("blue")),this.addHandler("yellow",e=>this.changeColor("yellow")),this.addHandler("gold",e=>this.changeColor("gold")),this.addHandler("white",e=>this.changeColor("white")),this.addHandler("silver",e=>this.changeColor("silver")),this.addHandler("gray",e=>this.changeColor("gray")),this.addHandler("dark",e=>this.changeColor("dark")),this.addHandler("black",e=>this.changeColor("black")),this.addHandler("sizeUp",e=>this.changeSize(!0)),this.addHandler("sizeDown",e=>this.changeSize(!1)),this.addHandler("footnote",e=>this.generateMark("\u811A\u6CE8","footnote")),this.addHandler("endnote",e=>this.generateMark("\u5C3E\u6CE8","endnote")),this.addHandler("term",e=>this.generateMark("\u672F\u8BED","term")),this.addHandler("anchor",e=>this.generateMark("\u951A\u70B9","anchor")),this.addHandler("convert-code",e=>this.togglePair("`")),this.addHandler("convert-latex",e=>this.togglePair("$")),this.addHandler("insert-icon",e=>this.generateIcon());for(let e=1;e<=6;e++)this.addHandler("heading-"+e,n=>this.toggleHeader(e));QuoteTypes.forEach(e=>{this.addHandler("quote-"+e,n=>this.toggleQuote(e))}),["ol","ul"].forEach(e=>{this.addHandler("list-"+e,n=>this.toggleList(e))}),this.addHandler("insert-table",e=>this.generateTable()),this.addHandler("insert-code",e=>this.insertCodeBlock()),this.addHandler("insert-latex",e=>this.insertLaTeX()),["left","center","right"].forEach(e=>{this.addHandler("align-"+e,n=>this.toggleAlign(e))}),["indent","outdent"].forEach(e=>{this.addHandler(e,n=>this.toggleIndent(e))}),["link","image","video","audio"].forEach(e=>{this.addHandler("insert-"+e,n=>this.generateLink(e))}),["normal","double","dotted","dashed","gradient","wavy","star"].forEach(e=>{this.addHandler("headline-"+e,n=>this.insertHeadLine(e))}),this.addHandler("insert-block",e=>this.generateRefBlock()),this.addHandler("Paste",(e,n,r)=>{var s=r.clipboardData.getData("text/html");return s?(MarkUp.reverse(s).then(i=>{e.insertBlock(i.split(`
`),!0,!0,!1)}),!0):!1})}clear(){this.title="untitled",this.filename="",super.clear()}read(t){this.Memory.reset(t),this.lastContent=t,this.contentChanged=!1;var e=document.createDocumentFragment();e.appendChild(newEle("div"));var n=e.firstChild;t.split(`
`).forEach((r,s)=>{var i=newEle("p");r.length===0?i.innerHTML="<br>":i.innerText=r,n.appendChild(i)}),this.Editor.innerHTML=n.innerHTML,this.requestContentUpdate(!0,!1),this.actionHandler("ContentUpdated",!1,t)}newFile(t){this.clear();var e=["\u6807\u9898\uFF1A\u65B0\u6587\u6863"];t&&e.push("\u4F5C\u8005\uFF1A"+t),e.push("\u66F4\u65B0\uFF1A"+timeNormalize(new Date)),e.push("\u5173\u952E\u8BCD\uFF1A\u672A\u5206\u7C7B"),e.push(""),e.push("");var n=e.join(`
`),r="<p>"+e.map(s=>s||"<br>").join("</p><p>")+"</p>";this.Editor.innerHTML=r,this.Memory.reset(n),this.lastContent=n,this.contentChanged=!1,this.actionHandler("ContentUpdated",!1,n)}read(t,e){this.filename=t,this.title=t.replace(/\.m[ud]$/i,""),super.read(e)}getBlocks(t,e){var n=this.getLines(),r=n.indexOf(t),s=n.indexOf(e),i=t.textContent;if(i){for(let l=r-1;l>=0;l--)if(!n[l].textContent){r=l+1;break}}else{let l=!1;for(let d=r+1;d<=s;d++)if(n[d].textContent){l=!0,r=d;break}if(!l)return[[],0,0]}if(i=e.textContent,i){for(let l=s+1;l<n.length;l++)if(!n[l].textContent){s=l-1;break}}else{let l=!1;for(let d=s-1;d>=r;d--)if(n[d].textContent){l=!0,s=d;break}if(!l)return[[],0,0]}var a=[],o=[];for(let l=r;l<=s;l++){let d=n[l];d.textContent?o.push(d):o.length>0&&(a.push(o),o=[])}return o.length>0&&a.push(o),[a,r,s]}insertNewLine(){var[t,e,n,r]=this.optimizeContent();if(!(!t||!n)){var s=document.getSelection(),i=s.getRangeAt(0),a=t.previousSibling;if(!!a){var o=a.textContent.replace(/^\n+|\n+$/g,""),l=o.match(this.LineHeadPrefix);if(!(!l||l[0].length===0)){if(l=l[0],o===l)this.Editor.removeChild(a),i.setStart(t,0),i.setEnd(t,0);else{l=l.replace(/(\d+)\.([ 　\t]+)$/,(h,c,u)=>c*1+1+"."+u);let d=t.textContent.replace(/^\n+|\n+$/g,"");t.innerText=l+d,t=t.childNodes.item(0),i.setStart(t,l.length),i.setEnd(t,l.length)}return s.removeAllRanges(),s.addRange(i),this.requestContentUpdate(!0,!0),!0}}}}togglePair(t,e){if(!t)return!1;e=e||t;var[n,r,s,i]=this.optimizeContent();if(n!==s)return!1;var a=n.textContent,o=a.substring(0,r+t.length),l=!1,d=-1,h=-1;if(t===e){let g=MarkupEditor.getAllPartsInLine(t,o);g.length>g.length>>1<<1&&(d=g[g.length-1][0])}else{let g=MarkupEditor.getAllPartsInLine(t,o);o=a.substring(0,r);let v=MarkupEditor.getAllPartsInLine(e,o);g.length>v.length&&(d=g[g.length-1][0])}if(d>=0)if(o=a.substring(d+t.length),h=o.indexOf(e),h>=0){let g=o.indexOf(t);g<0||g>=h?(l=!0,h+=d+t.length):(d=-1,h=-1)}else d=-1;if(l){let g=a.substring(0,d),v=a.substring(d+t.length,h),f=a.substring(h+e.length);a=g+v+f,r=d,i=h-t.length}else{let g=a.substring(0,r),v=a.substring(r,i),f=a.substring(i);a=g+t+v+e+f,i+=t.length+e.length}n.innerText=a,a=n.childNodes.item(0);var c=document.getSelection(),u=document.createRange();return u.setStart(a,r),u.setEnd(a,i),c.removeAllRanges(),c.addRange(u),this.contentChanged=!0,this.requestContentUpdate(!0),!0}changeColor(t){if(!!t&&(t=t.toLowerCase(),!!AvailableColors.includes(t))){var[e,n,r,s]=this.optimizeContent();if(e!==r)return!1;var i=e.textContent,a=!1,o=-1,l=-1,d=null;t="["+t+"]";var h=i.substring(0,s+ColorTailMark.length),c=MarkupEditor.getAllPartsInLine(ColorHeadMarkReg,h);h=i.substring(0,n);var u=MarkupEditor.getAllPartsInLine(ColorTailMark,h);if(c.length>u.length&&(o=c[c.length-1],d=o[1],o=o[0]),o>=0)if(h=i.substring(o+d.length),l=h.indexOf(ColorTailMark),l>=0){let f=h.match(ColorHeadMarkReg);!f||f.index>=l?(a=!0,l+=o+d.length):(o=-1,l=-1)}else o=-1;if(a)if(d===t){let f=i.substring(0,o),p=i.substring(o+d.length,l),m=i.substring(l+ColorTailMark.length);i=f+p+m,n=o,s=l-d.length}else{let f=i.substring(0,o),p=i.substring(o+d.length,l),m=i.substring(l+ColorTailMark.length);i=f+t+p+ColorTailMark+m,n=o,s=l-d.length+t.length+ColorTailMark.length}else{let f=i.substring(0,n),p=i.substring(n,s),m=i.substring(s);i=f+t+p+ColorTailMark+m,s+=t.length+ColorTailMark.length}e.innerText=i,i=e.childNodes.item(0);var g=document.getSelection(),v=document.createRange();return v.setStart(i,n),v.setEnd(i,s),g.removeAllRanges(),g.addRange(v),this.contentChanged=!0,this.requestContentUpdate(!0),!0}}changeSize(t=!0){var[e,n,r,s]=this.optimizeContent();if(e!==r)return!1;var i=e.textContent,a=0,o=-1,l=-1,d=0,h=0,c=i.substring(n).match(/[^\^]/);c?c=c.index:c=0;var u=i.substring(0,n+c),g=MarkupEditor.getAllPartsInLine(/\^{2,}/g,u);if(g.length>>1<<1!==g.length&&(o=g.last,d=o[1].length,o=o[0]),o>=0&&(u=i.substring(o+d),l=u.match(/\^{2,}/),l?(h=l[0].length,l=l.index+o+d):(o=-1,d=0)),a=Math.min(d,h),a===0&&!t||a>=5&&t)return!0;a>5&&(a=5),(o<0||l<0)&&(o=n,l=s),t?(a++,a>5&&(a=5),a<2&&(a=2)):(a--,a>5&&(a=5),a<2&&(a=0));var v=String.blank(a,"^"),f=i.substring(0,o),p=i.substring(o+d,l),m=i.substring(l+h);i=f+v+p+v+m,n=o,s=o+p.length+2*a,e.innerText=i,i=e.childNodes.item(0);var b=document.getSelection(),E=document.createRange();return E.setStart(i,n),E.setEnd(i,s),b.removeAllRanges(),b.addRange(E),this.contentChanged=!0,this.requestContentUpdate(!0),!0}generateMark(t,e){var[n,r,s,i]=this.optimizeContent();if(n!==s)return!1;var a=document.getSelection(),o=a.getRangeAt(0);return showInfobox({title:"\u63D2\u5165"+t,input:!0,action:"oc",callback:(l,d,h)=>{this.lastRange=null,a.removeAllRanges(),a.addRange(o),o=null,!(l==="cancel"||!d)&&this.insertMark(e,d,n,r,s,i)}}),!0}insertMark(t,e,n,r,s,i){if(!!e){if(!n&&([n,r,s,i]=this.optimizeContent(),n!==s))return!1;var a=n.textContent,o=a.substring(0,r),l=a.substring(r,i),d=a.substring(i),h="",c="",u=0,g=0;if(!!l&&l.length>0&&(h="["+l+"]"),t==="footnote"?(c="[:"+e+"]",u=2,g=1):t==="endnote"?(c="[^"+e+"]",u=2,g=1):(c="{"+e+"}",u=1,g=1),a=o+h+c+d,n.innerText=a,t==="anchor")r=o.length+h.length+u,i=r+e.length;else{let p=newEle("p"),m=newEle("p"),b="["+e+"]: ";p.innerHTML=b,m.innerHTML="<br>";let E=n.nextSibling;E?this.Editor.insertBefore(m,E):this.Editor.appendChild(m),this.Editor.insertBefore(p,m),n=p,r=b.length,i=r}var v=document.getSelection(),f=document.createRange();n=n.childNodes.item(0),f.setStart(n,r),f.setEnd(n,i),v.removeAllRanges(),v.addRange(f),this.contentChanged=!0,this.requestContentUpdate(!0)}}generateIcon(){var[t,e,n,r]=this.optimizeContent();if(t!==n)return!1;var s=document.getSelection(),i=s.getRangeAt(0);return showInfobox({title:"\u63D2\u5165 FontAwesome \u56FE\u6807",input:!0,action:"oc",callback:(a,o,l)=>{this.lastRange=null,s.removeAllRanges(),s.addRange(i),i=null,!(a==="cancel"||!o)&&this.insertIcon(o,t,e,n,r)}}),!0}insertIcon(t,e,n,r,s){if(!!t){if(!e&&([e,n,r,s]=this.optimizeContent(),e!==r))return!1;var i=e.textContent,a=i.substring(0,n),o=i.substring(s),l=" :"+t+": ";e.innerText=a+l+o;var d=document.getSelection(),h=document.createRange();e=e.childNodes.item(0),h.setStart(e,a.length),h.setEnd(e,a.length+l.length),d.removeAllRanges(),d.addRange(h),this.contentChanged=!0,this.requestContentUpdate(!0)}}generateTable(){var[t,e,n,r]=this.optimizeContent(),s=document.getSelection(),i=s.getRangeAt(0),a='<div class="table-generator" style="text-align:center;">';return a+='<div class="table-line">\u884C\uFF1A<input class="number-inputter row-count" type="number" value=2></div>',a+='<div class="table-line">\u5217\uFF1A<input class="number-inputter col-count" type="number" value=2></div>',a+="</div>",showInfobox({title:"\u63D2\u5165\u8868\u683C",mode:"html",content:a,input:!1,action:"oc",callback:(o,l,d)=>{if(this.lastRange=null,s.removeAllRanges(),s.addRange(i),i=null,o!=="cancel"){var h=d.$refs.content,c=h.querySelector("input.row-count"),u=h.querySelector("input.col-count");this.insertTable(c.value||2,u.value||2,t,e,n,r)}}}),!0}insertTable(t,e,n,r,s,i){if(!(!(t>0)||!(e>0))){var a=[],o=[];for(let l=1;l<=e;l++)o.push("\u6807\u9898"+l);a.push(o.join("|")),o=[];for(let l=0;l<e;l++)o.push("-");a.push(o.join("|"));for(let l=0;l<t;l++){o=[];for(let d=0;d<e;d++)o.push("  ");a.push(o.join("|"))}this.insertBlock(a,!1,!0,!0,n,r,s,i)}}toggleHeader(t){if(!(t>=0&&t<=6))return!1;var[e,n,r,s]=this.optimizeContent();if(e!==r)return!1;var i=!1,a=0,o=e.textContent;if(!o)return!1;if(o.match(/^(\-{3,}|={3,}|\+{3,}|_{3,}|\*{3,}|#{3,}|\.{3,})$/)){let h=o.substring(0,1),c=HeaderLevel[h]||0;if(e=e.previousSibling,!e||(o=e.textContent,!o||o.match(/^[ 　\t\-=\+\*>`\$#]*$/)))return!1;let u=o.match(/^#+/);!!u&&!!u[0]&&u[0].length>0?u=7-u[0].length:u=0,a=Math.max(c,u),i=!0}else{let h=o.match(/^#+/);!!h&&!!h[0]&&h[0].length>0?h=7-h[0].length:h=0;let c=e.nextSibling;if(c)if(c.textContent.match(/^(\-{3,}|={3,}|\+{3,}|_{3,}|\*{3,}|#{3,}|\.{3,})$/)){i=!0;let g=o.substring(0,1),v=HeaderLevel[g]||0;a=Math.max(h,v),r=c}else a=h;else a=h}if(a>0&&(a=7-a),a===t){if(t===0)return!1;t=0}i&&this.Editor.removeChild(r),o=e.textContent.replace(/^#+[ 　\t]*/,""),e.innerText=String.blank(t,"#")+(t>0?" ":"")+o,n=t,t>0&&n++,s=n+o.length;var l=document.getSelection(),d=document.createRange();return e=e.childNodes.item(0),d.setStart(e,n),d.setEnd(e,s),l.removeAllRanges(),l.addRange(d),this.contentChanged=!0,this.requestContentUpdate(!0),!0}toggleQuote(t){t&&QuoteTypes.includes(t)||(t="quote");var[e,n,r,s]=this.optimizeContent(),[i,a,o]=this.getBlocks(e,r),l=[],d=!0;if(i.forEach(g=>{var v=g[0].textContent,f="",p=v.match(/^( |　|\t)+/);p?f="quote":(p=v.match(/^([ 　\t\-\/\*>]|\d+\.)*>[ 　\t]*(\[(\w+)\])*[ 　\t]*/),p&&(f=p[3],f?(f=f.toLowerCase(),QuoteTypes.includes(f)||(f="quote")):f="quote")),l.push(f)}),l.some(g=>{if(g!==l[0])return d=!1,!0}),d&&l[0]===t)i.forEach(g=>{g.forEach(v=>{var f=v.textContent,p=!1;f=f.replace(/^( |　|\t)+/,()=>(p=!0,"")),p||(f=f.replace(/^(([ 　\t\-\/\*>]|\d+\.)*)>[ 　\t]*(\[(\w+)\])*[ 　\t]*/,(m,b)=>b)),v.innerText=f})});else{let g=">	";t!=="quote"&&(g+="["+t+"]	"),i.forEach(v=>{v.forEach((f,p)=>{var m=f.textContent,b=!1;p===0?(m=m.replace(/^( |　|\t)+/,()=>(b=!0,g)),b||(m=m.replace(/^(([ 　\t\-\/\*>]|\d+\.)*)>[ 　\t]*(\[(\w+)\])*[ 　\t]*/,(E,x)=>(b=!0,(x||"")+g))),b||(m=g+m)):(m=m.replace(/^( |　|\t)+/,()=>(b=!0,"")),b||(m=m.replace(/^(([ 　\t\-\/\*>]|\d+\.)*)>[ 　\t]*(\[(\w+)\])*[ 　\t]*/,(E,x)=>x||""))),f.innerText=m})})}e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var h=r.textContent,c=document.getSelection(),u=document.createRange();return u.setStart(e,0),u.setEnd(r,h.length),c.removeAllRanges(),c.addRange(u),this.contentChanged=!0,this.requestContentUpdate(!0),!0}toggleList(t){if(t!=="ul"&&t!=="ol")return!1;var[e,n,r,s]=this.optimizeContent(),[i,a,o]=this.getBlocks(e,r);const l=/^(([ 　\t>]|\d+\.[ 　\t]|[\-\+\*][ 　\t])*)(([\-\+\*]|\d+\.)[ 　\t])/,d=/^(([ 　\t>]|\d+\.[ 　\t]|[\-\+\*][ 　\t])*)(([\-\+\*]|\d+\.)[ 　\t])*/;var h=[],c=!0;i.forEach(f=>{var p="";f.forEach(m=>{var b=m.textContent,E="",x=b.match(l);!!x&&!!x[3]?(x[3].match(/^[\-\+\*]/)?E="ul":E="ol",p=E):E=p,h.push(E)})}),h.some(f=>{if(f!==h[0])return c=!1,!0}),c&&h[0]===t?i.forEach(f=>{f.forEach(p=>{var m=p.textContent;m=m.replace(l,(b,E)=>E||""),p.innerText=m})}):i.forEach(f=>{f.forEach((p,m)=>{var b=p.textContent,E=!1,x=t==="ol"?m+1+".	":"-	";b=b.replace(d,(w,T)=>(E=!0,(T||"")+x)),E||(b=x+b),p.innerText=b})}),e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var u=r.textContent,g=document.getSelection(),v=document.createRange();return v.setStart(e,0),v.setEnd(r,u.length),g.removeAllRanges(),g.addRange(v),this.contentChanged=!0,this.requestContentUpdate(!0),!0}insertCodeBlock(){var t=[];return t.push("``` javascript"),t.push("codes here..."),t.push("```"),this.insertBlock(t,!1,!0,!0)}insertLaTeX(){var t=[];return t.push("$$"),t.push("latex equation here..."),t.push("$$"),this.insertBlock(t,!1,!0,!0)}toggleAlign(t){t!=="center"&&t!=="right"&&(t="left");var[e,n,r,s]=this.optimizeContent(),[i,a,o]=this.getBlocks(e,r),l=[],d=!0;if(i.forEach(g=>{var v=g.first.textContent,f="",p=v.match(/^( |　|\t|>|\-|\+|\*|~|\d+\.)*\{([<\|>])\}/);if(!!p&&!!p[2]){let m=p[2];m==="<"?f="left":m==="|"?f="center":m===">"&&(f="right")}else f="left";l.push(f)}),l.some(g=>{if(g!==l[0])return d=!1,!0}),d&&l[0]===t)i.forEach(g=>{var v=g.first,f=v.textContent;f=f.replace(/^(( |　|\t|>|\-|\+|\*|~|\d+\.)*)\{[<\|>]\}[ 　\t]*/,(p,m)=>m||""),v.innerText=f});else{let g="";t==="center"?g="{|}	":t==="right"&&(g="{>}	"),i.forEach(v=>{var f=v.first,p=f.textContent;p=p.replace(/^(( |　|\t|>|\-|\+|\*|~|\d+\.)*)(\{[<\|>]\}[ 　\t]*)*/,(m,b)=>(b||"")+g),f.innerText=p})}e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var h=r.textContent,c=document.getSelection(),u=document.createRange();return u.setStart(e,0),u.setEnd(r,h.length),c.removeAllRanges(),c.addRange(u),this.contentChanged=!0,this.requestContentUpdate(!0),!0}toggleIndent(t){if(t!=="indent"&&t!=="outdent")return!1;var[e,n,r,s]=this.optimizeContent(),[i,a,o]=this.getBlocks(e,r);i.forEach(c=>{var u=c.first.textContent,g="";u=u.replace(/^(( |　|\t|>|\-|\+|\*|~|\d+\.|\{[<\|>]\})*)(:*)([ 　\t]*)/,(v,f,p,m,b)=>(f=f||"",m=m||"",b=b||"",t==="outdent"?m.length>0?m=m.substring(1):(m="",b=""):(m=m+":",b=b||" "),f+m+b)),c.first.innerText=u}),e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var l=r.textContent,d=document.getSelection(),h=document.createRange();return h.setStart(e,0),h.setEnd(r,l.length),d.removeAllRanges(),d.addRange(h),this.contentChanged=!0,this.requestContentUpdate(!0),!0}generateLink(t){var[e,n,r,s]=this.optimizeContent();if(e!==r)return!1;var i=document.getSelection(),a=i.getRangeAt(0),o=e.textContent||"",l=o.substring(n,s),d='<div class="link-generator" style="text-align:center;">';d+='<div class="link-line">\u6807\u9898\uFF1A<input class="number-inputter link-title" value="'+l+'"></div>',d+='<div class="link-line">\u5730\u5740\uFF1A<input class="number-inputter link-address" value=""></div>';var h="\u8D85\u94FE\u63A5",c='<div class="link-line button-line" style="margin-top:10px;font-size:14px;">';return c+='<input type="radio" name="position" value="nextline" checked><span class="name">\u72EC\u7ACB\u4E00\u884C</span><br>',c+='<input type="radio" name="position" value="floatleft"><span class="name">\u5DE6\u4FA7\u6DF7\u6392</span><br>',c+='<input type="radio" name="position" value="floatright"><span class="name">\u53F3\u4FA7\u6DF7\u6392</span>',c+="</div>",t==="image"?(h="\u56FE\u7247",d+=c):t==="video"?(h="\u89C6\u9891",d+=c):t==="audio"&&(h="\u97F3\u9891",d+=c),d+="</div>",showInfobox({title:"\u63D2\u5165"+h,mode:"html",content:d,input:!1,action:"oc",callback:(u,g,v)=>{if(this.lastRange=null,i.removeAllRanges(),i.addRange(a),a=null,u!=="cancel"){var f=v.$refs.content,p=f.querySelector("input.link-address").value;if(!!p){var m=f.querySelector("input.link-title").value,b="nextline";f.querySelectorAll('input[type="radio"][name="position"]').forEach(E=>{E.checked&&(b=E.value)}),this.insertLink(t,m,p,b,e,n,r,s)}}}}),!1}insertLink(t,e,n,r,s,i,a,o){s||([s,i,a,o]=this.optimizeContent());var l=s.textContent,d=l.substring(0,i),h=l.substring(i,o),c=l.substring(o),u="["+e+"]("+n,g=!1;t==="image"?(u="!"+u,g=!0):t==="image"?(u="@"+u,g=!0):t==="image"&&(u="#"+u,g=!0),g?r==="floatleft"?u+=' "left")':r==="floatright"?u+=' "right")':u+=")":u+=")";var v=document.getSelection(),f=document.createRange();s.innerText=d+u+c,i=d.length,o=i+u.length,s=s.childNodes.item(0),f.setStart(s,i),f.setEnd(s,o),v.removeAllRanges(),v.addRange(f)}insertHeadLine(t){var[e,n,r,s]=this.optimizeContent(),i="---";return t==="double"?i="===":t==="dotted"?i="...":t==="dashed"?i="___":t==="gradient"?i="+++":t==="wavy"?i="~~~":t==="star"&&(i="***"),this.insertBlock(i,!1,!0,!0,e,n,r,s),!0}generateRefBlock(){var[t,e,n,r]=this.optimizeContent();if(t!==n)return!1;var s=document.getSelection(),i=s.getRangeAt(0),a=t.textContent||"";a=a.substring(e,r);var o='<div class="table-generator" style="text-align:center;">';return o+='<div class="table-line">\u540D\u79F0\uFF1A<input class="number-inputter block-name" value=""></div>',o+="</div>",showInfobox({title:"\u63D2\u5165\u5F15\u7528\u5757",mode:"html",content:o,input:!1,action:"oc",callback:(l,d,h)=>{if(this.lastRange=null,s.removeAllRanges(),s.addRange(i),i=null,l!=="cancel"){var c=h.$refs.content,u=c.querySelector("input.block-name").value;!u||this.insertRefBlock(u,a,t,e,n,r)}}}),!1}insertRefBlock(t,e,n,r,s,i){n||([n,r,s,i]=this.optimizeContent());var a=n.textContent,o=a.substring(0,r);e=e||a.substring(r,i);var l=a.substring(i),d="["+t+"]";n.innerText=o+d+l;var h=this.getBlocks(n,n)[0][0];if(n=h.last,s=n.nextElementSibling,d="[:"+t+":]",s){let g=newEle("p");g.innerHTML="<br>",this.Editor.insertBefore(g,s),n=newEle("p"),n.innerText=d+e+d,this.Editor.insertBefore(n,s)}else{let g=newEle("p");g.innerHTML="<br>",this.Editor.appendChild(g),n=newEle("p"),n.innerText=d+e+d,this.Editor.appendChild(n)}var c=document.getSelection(),u=document.createRange();r=d.length,i=r+e.length,n=n.childNodes.item(0),u.setStart(n,r),u.setEnd(n,i),c.removeAllRanges(),c.addRange(u)}onScrolled(){if(this.tmrScroll&&(clearTimeout(this.tmrScroll),this.tmrScroll=null),!(this.Editor.parentNode.scrollHeight<=this.Editor.parentNode.offsetHeight)){var t=this.Editor.parentNode.scrollTop/(this.Editor.parentNode.scrollHeight-this.Editor.parentNode.offsetHeight),e=this.Editor.parentNode.getBoundingClientRect();e=e.top+e.height*t;var n=[].map.call(this.Editor.childNodes,d=>d),r=-1,s=!0,i=!1;n.some((d,h)=>{if(!d.getBoundingClientRect)return s&&r++,s=!1,i=!0,!1;s?r++:s=!0,i=!1;var c=d.getBoundingClientRect();return c.top>=e}),i||r--;var a,o,l;if(this.lineMap.some(d=>{if(d<r&&(a=d),d===r&&(o=d),d>r)return l=d,!0}),o>=0){if(o=this.getTargetNode(o),!o)return;o=o.getBoundingClientRect();let d=o.top-this.Preview.getBoundingClientRect().top,h=this.Editor.parentElement;if(h.scrollHeight>h.offsetHeight){let c=h.scrollTop/(h.scrollHeight-h.offsetHeight);d-=(h.getBoundingClientRect().height-o.height)*c}this.Preview.parentElement.scrollTo({top:d,left:0,behavior:"smooth"})}else{if(!(a>=0)||!(l>=0))return;{let d=(r-a)/(l-a);if(a=this.getTargetNode(a),!a||(l=this.getTargetNode(l),!l))return;a=a.getBoundingClientRect(),l=l.getBoundingClientRect();let h=l.top+l.height-a.top,c=a.top+h*d-this.Preview.getBoundingClientRect().top,u=this.Editor.parentElement,g=u.scrollHeight>u.offsetHeight?u.scrollTop/(u.scrollHeight-u.offsetHeight):0;c-=u.getBoundingClientRect().height*g,this.Preview.parentElement.scrollTo({top:c,left:0,behavior:"smooth"})}}}}getTargetNode(t){if(!(t>=0))return null;var e=this.Preview.querySelectorAll('span.linenumbermarker[linenumber="'+t+'"]');if(e=[].map.call(e,s=>s),e=e.filter(s=>!s.parentElement.classList.contains("content-link")),e.length===0)return null;var n=this.Preview.parentElement,r=n.getBoundingClientRect().top;return e=e.map(s=>[Math.abs(s.getBoundingClientRect().top-r),s]),e.sort((s,i)=>s[0]-i[0]),e[0][1]}async markupDoc(t){var e=await MarkUp.fullParse(t,{showtitle:!0,classname:"markup-content"});this.Preview.innerHTML=e.content,this.WordCountHint.innerText=e.wordCount,this.title=e.title,this.actionHandler("markupUpdated")}static notTextLine(t,e=!1,n=""){if(t.length===0||!!t.match(/^ *$/))return[!0,!1,n];if(e)return[!0,!0,n];if(t.match(/^\[.+\][:：][ 　\t]*/))return[!0,!0,n];if(n){if(n==="$")return t.match(/^\$\$/)&&(n=""),[!0,e,n];if(n==="`")return t.match(/^```/)&&(n=""),[!0,e,n];if(n==="~")return t.match(/^~~~/)&&(n=""),[!0,e,n]}else{let r=t.match(/(\$\$|~~~|```)/);if(r){let s=r.index,i=t.substring(0,s),a=i.match(/(>|\-|\+|\*|\d+| |　|\t)*/);if(!!a&&a[0]===i)return[!0,e,r[0].substring(0,1)]}}return t.match(/^(标题|作者|简介|关键词|更新|GOD|THEONE|TITLE|AUTHOR|EMAIL|DESCRIPTION|STYLE|SCRIPT|DATE|KEYWORD|GLOSSARY|TOC|REF|LINK|IMAGES|VIDEOS|AUDIOS|ARCHOR|SHOWTITLE|SHOWAUTHOR|RESOURCES)[:：]/i)?[!0,e,n]:t.match(/[ 　\t\w\u4e00-\u9fa5]/)?t.match(/[!@#]\[.*\]\(.+\)/)?[!0,e,n]:t.match(/^[ 　\t]*\[.+\][ 　\t]*$/)?[!0,e,n]:t.match(/^\|>.*<\|$/)?[!0,e,n]:[!1,e,n]:[!0,e,n]}static getAllPartsInLine(t,e){var n=[];if(t instanceof RegExp)if(t.global){let r=e.match(t);r&&r.reverse().forEach(s=>{var i=e.lastIndexOf(s);i<0||(n.unshift([i,s]),e=e.substring(0,i))})}else{let r=0;for(;;){let s=e.match(t);if(!s)break;let i=s[0];s=s.index,r+=s,n.push([r,i]),r+=i.length,s+=i.length,e=e.substring(s)}}else for(;;){let r=e.lastIndexOf(t);if(r<0)break;n.unshift([r,t]),e=e.substring(0,r)}return n}}const resizeEditor=(C,t,e,n)=>{var r=document.body.getBoundingClientRect().width,s=!0;if(r<1e3&&(s=!1,C.notAutoUpdateContent=!0,t.parentElement.parentElement.classList.add("no_preview"),n.parentElement.classList.add("no_preview"),console.log(C,t,e,n)),r<=690){let i=C.MenuBar.items.length,a=C.MenuBar.items[i-3];a.ui.style.display="none",a=C.MenuBar.items[i-4],a.ui.style.display="none",a=C.MenuBar.items[i-7],a.ui.style.display="none",a=C.MenuBar.items[i-8],a.ui.style.display="none"}if(r<=580){let i=C.MenuBar.items.length,a=C.MenuBar.items[i-10];a.ui.style.display="none",a=C.MenuBar.items[i-12],a.ui.style.display="none"}if(r<=440){let i=C.MenuBar.items.length,a=C.MenuBar.items[i-15];a.ui.style.display="none"}if(r<=380){let i=C.MenuBar.items.length,a=C.MenuBar.items[i-6];a.ui.style.display="none",a=C.MenuBar.items[i-9],a.ui.style.display="none",a=C.MenuBar.items[i-11],a.ui.style.display="none",a=C.MenuBar.items[i-13],a.ui.style.display="none",a=C.MenuBar.items[i-14],a.ui.style.display="none",a=C.MenuBar.items[i-16],a.ui.style.display="none"}if(s){let i=C.MenuBar.items.length,a=C.MenuBar.items[i-5];a.ui.style.display="none",a=C.MenuBar.items[i-6],a.ui.style.display="none",t.parentElement.parentElement.classList.remove("no_preview"),n.parentElement.classList.remove("no_preview")}};window.initMarkUpEditor=(C,t,e,n,r)=>{var s=new MarkupEditor({ui:{editor:C,toolbar:t,preview:e,wordcount:n},callback:r,shortcuts:Shortcuts,toolbar:MenuConfig}),i=new Map;resizeEditor(s,C,e,n),s.addHandler("markupUpdated",()=>{var d=e.querySelectorAll(".latex");for(let h of d){let c="MATHJAX::"+h.innerText;h._origin=c;let u=i.get(c);u?(h.classList.add("rendered"),h.innerHTML=u):MathJax.Hub.Queue(["Typeset",MathJax.Hub,h])}}),s.addHandler("preview",async()=>{var d=C.parentElement.parentElement;if(d.classList.contains("show_preview"))d.classList.remove("show_preview");else{d.classList.add("show_preview");let h=s.getContent(),c=await MarkUp.fullParse(h,{showtitle:!0,classname:"markup-content"});e.innerHTML=c.content,s.title=c.title,s.actionHandler("markupUpdated")}}),e.addEventListener("click",d=>{d.preventDefault()}),initMathJax.initialized||(initMathJax(),MathJax.Hub.Register.MessageHook("End Process",d=>{var[h,c]=d;if(h==="End Process"&&c!==document.body){var u=(c.innerText||"").toLowerCase();u.length===0||u.indexOf("error")>=0||c._origin&&i.set(c._origin,c.innerHTML)}})),s.actionHandler("init",!1)||s.newFile();var a=document.getSelection(),o=document.createRange(),l=s.Editor.lastChild;return o.setStart(l,0),o.setEnd(l,0),a.removeAllRanges(),a.addRange(o),s};
