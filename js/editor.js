const BlockLevelTags=["h1","h2","h3","h4","h5","h6","p","div","blockquote","ul","ol","li","article","section","dl","table","tbody","thead","tr","form","caption","legend","main","aside","nav","footer","header"].map(C=>C.toUpperCase()),DefaultFontAwesomeIcons=["glass","music","search","envelope","heart","star","star-empty","user","film","th-large","th","th-list","ok","remove","zoom-in","zoom-out","off","signal","cog","trash","home","file","time","road","download-alt","download","upload","inbox","play-circle","repeat","refresh","list-alt","lock","flag","headphones","volume-off","volume-down","volume-up","qrcode","barcode","tag","tags","book","bookmark","print","camera","font","bold","italic","text-height","text-width","align-left","align-center","align-right","align-justify","list","indent-left","indent-right","facetime-video","picture","pencil","map-marker","adjust","tint","edit","share","check","move","step-backward","fast-backward","backward","play","pause","stop","forward","fast-forward","step-forward","eject","chevron-left","chevron-right","plus-sign","minus-sign","remove-sign","ok-sign","question-sign","info-sign","screenshot","remove-circle","ok-circle","ban-circle","arrow-left","arrow-right","arrow-up","arrow-down","share-alt","resize-full","resize-small","plus","minus","asterisk","exclamation-sign","gift","leaf","fire","eye-open","eye-close","warning-sign","plane","calendar","random","comment","magnet","chevron-up","chevron-down","retweet","shopping-cart","folder-close","folder-open","resize-vertical","resize-horizontal","bar-chart","twitter-sign","facebook-sign","camera-retro","key","cogs","comments","thumbs-up","thumbs-down","star-half","heart-empty","signout","linkedin-sign","pushpin","external-link","signin","trophy","github-sign","upload-alt","lemon","phone","check-empty","bookmark-empty","phone-sign","twitter","facebook","github","unlock","credit-card","rss","hdd","bullhorn","bell","certificate","hand-right","hand-left","hand-up","hand-down","circle-arrow-left","circle-arrow-right","circle-arrow-up","circle-arrow-down","globe","wrench","tasks","filter","briefcase","fullscreen","group","link","cloud","beaker","cut","copy","paper-clip","save","sign-blank","reorder","list-ul","list-ol","strikethrough","underline","table","magic","truck","pinterest","pinterest-sign","google-plus-sign","google-plus","money","caret-down","caret-up","caret-left","caret-right","columns","sort","sort-down","sort-up","envelope-alt","linkedin","undo","legal","dashboard","comment-alt","comments-alt","bolt","sitemap","umbrella","paste","lightbulb","exchange","cloud-download","cloud-upload","user-md","stethoscope","suitcase","bell-alt","coffee","food","file-alt","building","hospital","ambulance","medkit","fighter-jet","beer","h-sign","plus-sign-alt","double-angle-left","double-angle-right","double-angle-up","double-angle-down","angle-left","angle-right","angle-up","angle-down","desktop","laptop","tablet","mobile-phone","circle-blank","quote-left","quote-right","spinner","circle","reply"],AvailableColors=["red","green","blue","yellow","gold","white","silver","gray","dark","black"],ColorHeadMarkReg=new RegExp("\\[("+AvailableColors.join("|")+")\\]"),ColorTailMark="[/]",QuoteTypes=["quote","info","success","warning","danger"],HeaderLevel={"=":6,"-":5,"+":4,_:4,"*":3,"#":2,".":1},MenuConfig=[[{name:"\u4FDD\u5B58",icon:"save",action:"save-article",shortcut:"ctrl+S"},"line",{name:"\u4E0B\u8F7D",icon:"download",action:"download-file",shortcut:"ctrl+alt+S"},{name:"\u6253\u5F00\u672C\u5730\u6587\u6863",icon:"upload",action:"upload-file",shortcut:"ctrl+alt+O"},"line",{name:"\u65B0\u5EFA\u7A7A\u6587\u6863",icon:"file",action:"NewFile",shortcut:"ctrl+N"}],"line",[{name:"\u52A0\u7C97",icon:"bold",action:"bold",shortcut:"ctrl+B"},{name:"\u659C\u4F53",icon:"italic",action:"italic",shortcut:"ctrl+I"},{name:"\u4E0B\u5212\u7EBF",icon:"underline",action:"underline",shortcut:"alt+U"},{name:"\u6CE2\u6D6A\u7EBF",icon:"water",action:"wavy",shortcut:"alt+W"},{name:"\u5220\u9664\u7EBF",icon:"strikethrough",action:"throughLine",shortcut:"alt+D"},"line",[{name:"\u7EA2\u8272",icon:"color red",action:"red"},{name:"\u7EFF\u8272",icon:"color green",action:"green"},{name:"\u84DD\u8272",icon:"color blue",action:"blue"},{name:"\u9EC4\u8272",icon:"color yellow",action:"yellow"},{name:"\u91D1\u8272",icon:"color gold",action:"gold"},{name:"\u767D\u8272",icon:"color white",action:"white"},{name:"\u94F6\u8272",icon:"color silver",action:"silver"},{name:"\u7070\u8272",icon:"color gray",action:"gray"},{name:"\u6DF1\u8272",icon:"color dark",action:"dark"},{name:"\u9ED1\u8272",icon:"color black",action:"black"}],"line",{name:"\u4E0A\u6807",icon:"superscript",action:"sup",shortcut:"alt+P"},{name:"\u4E0B\u6807",icon:"subscript",action:"sub",shortcut:"alt+B"},"line",{name:"\u5927\u4E00\u53F7",icon:"sort-amount-up",action:"sizeUp",shortcut:"ctrl+Up"},{name:"\u5C0F\u4E00\u53F7",icon:"sort-amount-down",action:"sizeDown",shortcut:"ctrl+Down"}],[{name:"\u811A\u6CE8",icon:"paragraph",action:"footnote",shortcut:"alt+F"},{name:"\u5C3E\u6CE8",icon:"scroll",action:"endnote",shortcut:"alt+E"},{name:"\u672F\u8BED",icon:"pen-nib",action:"term",shortcut:"alt+T"},{name:"\u951A\u70B9",icon:"map-pin",action:"anchor",shortcut:"alt+A"},"line",{name:"\u884C\u5185\u4EE3\u7801",icon:"code",action:"convert-code",shortcut:"alt+C"},{name:"\u884C\u5185\u516C\u5F0F",icon:"square-root-alt",action:"convert-latex",shortcut:"alt+L"},"line",{name:"\u63D2\u5165\u56FE\u6807",icon:"flag",action:"insert-icon"}],"line",[[{name:"\u4E00\u7EA7\u6807\u9898",icon:"heading one",action:"heading-1",shortcut:"alt+H"},{name:"\u4E8C\u7EA7\u6807\u9898",icon:"heading two",action:"heading-2"},{name:"\u4E09\u7EA7\u6807\u9898",icon:"heading three",action:"heading-3"},{name:"\u56DB\u7EA7\u6807\u9898",icon:"heading four",action:"heading-4"},{name:"\u4E94\u7EA7\u6807\u9898",icon:"heading five",action:"heading-5"},{name:"\u516D\u7EA7\u6807\u9898",icon:"heading six",action:"heading-6"}],"line",[{name:"\u666E\u901A\u5F15\u7528",icon:"quote-right",action:"quote-quote"},{name:"\u4FE1\u606F\u5F15\u7528",icon:"quote-left",action:"quote-info"},{name:"\u63D0\u9192\u5F15\u7528",icon:"angle-double-right font green",action:"quote-success"},{name:"\u8B66\u544A\u5F15\u7528",icon:"angle-right",action:"quote-warning"},{name:"\u62A5\u9519\u5F15\u7528",icon:"angle-double-right font red",action:"quote-danger"}],[{name:"\u65E0\u5E8F\u5217\u8868",icon:"list-ul",action:"list-ul"},{name:"\u6709\u5E8F\u5217\u8868",icon:"list-ol",action:"list-ol"}],{name:"\u8868\u683C",icon:"table",action:"insert-table"},"line",{name:"\u4EE3\u7801",icon:"code",action:"insert-code",shortcut:"ctrl+alt+C"},{name:"\u516C\u5F0F",icon:"square-root-alt",action:"insert-latex",shortcut:"ctrl+alt+L"}],[{name:"\u5C42\u8FDB",icon:"indent",action:"TabIndent"},{name:"\u5C42\u51FA",icon:"outdent",action:"TabOutdent"},"line",{name:"\u5DE6\u5BF9\u9F50",icon:"align-left",action:"align-left"},{name:"\u5C45\u4E2D",icon:"align-center",action:"align-center"},{name:"\u53F3\u5BF9\u9F50",icon:"align-right",action:"align-right"},"line",{name:"\u7F29\u8FDB",icon:"indent font blue",action:"indent",shortcut:"ctrl+alt+Right"},{name:"\u9000\u51FA",icon:"outdent font blue",action:"outdent",shortcut:"ctrl+alt+Left"}],"line",[{name:"\u63D2\u5165\u8D85\u94FE\u63A5",icon:"link",action:"insert-link",shortcut:"alt+K"},{name:"\u63D2\u5165\u56FE\u7247",icon:"image",action:"insert-image"},{name:"\u63D2\u5165\u89C6\u9891",icon:"video",action:"insert-video"},{name:"\u63D2\u5165\u97F3\u9891",icon:"music",action:"insert-audio"}],[{name:"\u666E\u901A\u5206\u9694\u7EBF",icon:"minus",action:"headline-normal"},{name:"\u53CC\u5C42\u5206\u9694\u7EBF",icon:"grip-lines",action:"headline-double"},{name:"\u865A\u7EBF",icon:"ellipsis-h",action:"headline-dotted"},{name:"\u70B9\u5212\u7EBF",icon:"window-minimize",action:"headline-dashed"},{name:"\u6E10\u53D8\u7EBF",icon:"icicles",action:"headline-gradient"},{name:"\u4EA4\u53C9\u7EBF",icon:"grip-horizontal",action:"headline-wavy"},{name:"\u5708\u9694\u7EBF",icon:"genderless",action:"headline-star"}],"line",{name:"\u63D2\u5165\u5F15\u7528\u5757",icon:"vector-square",action:"insert-block"},"line",{name:"\u9884\u89C8",icon:"eye",action:"preview"},"line",{name:"\u5E2E\u52A9\u6587\u6863",icon:"info-circle",action:"help",shortcut:"ctrl+H"},"line",{name:"\u5173\u95ED\u672C\u6587\u6863",icon:"times-circle",action:"close"}],Shortcuts={Enter:"Enter",Tab:"TabIndent","shift+Tab":"TabOutdent","ctrl+Tab":"TabOutdent","ctrl+alt+Up":"BlockUp","ctrl+alt+Down":"BlockDown","ctrl+shift+Up":"BlockUp","ctrl+shift+Down":"BlockDown","ctrl+Z":"Undo","ctrl+Y":"Redo"},newID=(C=32)=>{var t=[];for(let e=0;e<C;e++)t.push(Math.floor(Math.random()*36).toString(36));return t.join("")};class MenuItem{constructor(t,e,n,r){r=r?r.trim():"",r&&(t=t+"\uFF08"+r+"\uFF09"),this.key=n||e,this.name=t,this.icon=e,this.shortcut=r,this.ui=newEle("div","menu-item"),this.ui.innerHTML='<i class="fa fas far fab fa-'+e+'"></i><span class="menu-item-hint">'+t+"</span>",this.container=null,this.ui.addEventListener("click",()=>{!this.container||this.container.onClick(this.key,this)})}update(t,e,n){var r=this.ui.querySelector("i.fa");r.className="fa fas far fab fa-"+e,this.ui.querySelector("span.menu-item-hint").innerHTML=t,this.key=n,this.name=t,this.icon=e}getShortcuts(){var t={};return this.shortcut&&(t[this.shortcut]=this.key),t}}class MenuLine extends MenuItem{constructor(){super();this.ui=newEle("div","menu-break-line")}}class MenuGroup{constructor(t){this.items=[],this.name="",this.icon="",this.key="",this.container,this.btn=new MenuItem("","",""),this.btn.container=this,this.group=newEle("div","menu-group-area"),this.ui=newEle("div","menu-group"),this.ui.appendChild(this.btn.ui),this.ui.appendChild(this.group),t.forEach(e=>{if(e==="line")this.add(new MenuLine);else if(Array.is(e))this.add(new MenuGroup(e));else if(!!e.name&&!!e.action){let n=[e.name,e.icon||e.action,e.action];e.shortcut&&n.push(e.shortcut),this.add(...n)}})}add(t,e,n,r){if(t instanceof MenuItem)t.container=this,this.items.push(t),this.group.appendChild(t.ui);else if(t instanceof MenuGroup)t.ui.classList.add("menu-subgroup"),t.container=this,this.items.push(t),this.group.appendChild(t.ui);else{let a=new MenuItem(t,e,n,r);a.container=this,this.items.push(a),this.group.appendChild(a.ui)}if(this.items.length===1){let a=this.items[0];this.btn.update(a.name,a.icon,a.key),this.name=a.name,this.icon=a.icon,this.key=a.key}}onClick(t,e){this.btn.update(e.name,e.icon,e.key),this.name=e.name,this.icon=e.icon,this.key=e.key,!!this.container&&this.container.onClick(t,e)}getShortcuts(){var t={};return this.items.forEach(e=>{e=e.getShortcuts(),Object.keys(e).forEach(n=>{n&&(t[n]=e[n])})}),t}}class MenuBar{constructor(t,e){this.items=[],this.ui=newEle("div","menu-bar"),this.hooker=e,t.forEach(n=>{if(n==="line")this.add(new MenuLine);else if(Array.is(n))this.add(new MenuGroup(n));else if(!!n.name&&!!n.action){let r=[n.name,n.icon||n.action,n.action];n.shortcut&&r.push(n.shortcut),this.add(...r)}})}add(t,e,n,r){if(t instanceof MenuItem)t.ui.classList.add("top-level"),this.items.push(t),this.ui.appendChild(t.ui),t.container=this;else if(t instanceof MenuGroup)this.items.push(t),this.ui.appendChild(t.ui),t.container=this;else{let a=new MenuItem(t,e,n,r);a.ui.classList.add("top-level"),this.items.push(a),this.ui.appendChild(a.ui),a.container=this}}onClick(t,e){!this.hooker||this.hooker(t)}getShortcuts(){var t={};return this.items.forEach(e=>{e=e.getShortcuts(),Object.keys(e).forEach(n=>{n&&(t[n]=e[n])})}),t}}class HistoryManager{constructor(){this.index=-1,this.memory=[]}reset(t=null){this.memory.splice(0,this.memory.length),t===null?this.index=-1:(this.index=0,this.memory[0]=[t,0,0,0,0])}add(t,e,n,r,a){this.index++,this.memory.splice(this.index,this.memory.length),this.memory[this.index]=[t,e,n,r,a]}undo(){if(!(this.index<=0))return this.index--,this.memory[this.index]}redo(){if(!(this.index>=this.memory.length-1))return this.index++,this.memory[this.index]}}class Editor extends EventEmitter{constructor(t){super();if(!!t.ui?.editor){if(this.Toolbar=null,this.MenuBar=null,this.Shortcuts=new Map,this.ActionHandlers=new Map,this.Memory=new HistoryManager,this.LineHeadPrefix=/^[ 　\t]+/,this.imeOn=!1,this.lastContent="",this.contentChanged=!1,this.tmrChanger=null,this.lastRange=null,this.Editor=String.is(t.ui.editor)?document.querySelector(t.ui.editor):t.ui.editor,document.execCommand("defaultParagraphSeparator",!1,"p"),document.execCommand("insertbronreturn",!1,!1),this.Editor.addEventListener("keydown",e=>this.onKeyDown(e)),this.Editor.addEventListener("keyup",e=>this.onKeyUp(e)),this.Editor.addEventListener("compositionstart",e=>this.onIMEStart(e)),this.Editor.addEventListener("compositionend",e=>this.onIMEEnd(e)),this.Editor.addEventListener("drop",e=>this.onDrop(e)),this.Editor.addEventListener("copy",e=>this.onCopy(e)),this.Editor.addEventListener("cut",e=>this.onCut(e)),this.Editor.addEventListener("paste",e=>this.onPaste(e)),this.Editor.addEventListener("blur",e=>this.onBlur(e)),this.Editor.parentElement.addEventListener("mousewheel",e=>this.onWheel(e)),this.Editor.parentElement.addEventListener("scroll",e=>this.onWheel(e)),this.Editor.innerText===""&&this.clear(),this.WordCountHint=String.is(t.ui.wordcount)?document.querySelector(t.ui.wordcount):t.ui.wordcount,this.WordCountHint.innerText=0,t.ui?.toolbar){this.Toolbar=String.is(t.ui.toolbar)?document.querySelector(t.ui.toolbar):t.ui.toolbar,this.MenuBar=new MenuBar(t.toolbar,(...n)=>this.actionHandler(...n)),this.Toolbar.appendChild(this.MenuBar.ui);let e=this.MenuBar.getShortcuts();Object.keys(e).forEach(n=>this.addShortcut(n,e[n]))}if(t.shortcuts)for(let e in t.shortcuts)this.addShortcut(e,t.shortcuts[e]);this.addHandler("TabIndent",(e,n,r)=>this.blockIndent(e,!0)),this.addHandler("TabOutdent",(e,n,r)=>this.blockIndent(e,!1)),this.addHandler("BlockUp",(e,n,r)=>this.moveBlock(e,!0)),this.addHandler("BlockDown",(e,n,r)=>this.moveBlock(e,!1)),this.addHandler("Enter",(e,n,r)=>this.insertNewLine()),this.addHandler("Undo",(e,n,r)=>this.recallMemory(!0)),this.addHandler("Redo",(e,n,r)=>this.recallMemory(!1)),this.addHandler("NewFile",(e,n,r)=>(this.newFile(),!0));for(let e in t.callback)this.addHandler(e,t.callback[e])}}clear(){this.Memory.reset(""),this.lastContent="",this.contentChanged=!1,this.initialBlankContent(!0)}read(t){this.Memory.reset(t),this.lastContent=t,this.contentChanged=!1;var e=document.createDocumentFragment();e.appendChild(newEle("div"));var n=e.firstChild;t.split(`
`).forEach((r,a)=>{var i=newEle("p");r.length===0?i.innerHTML="<br>":i.innerText=r,n.appendChild(i)}),this.Editor.innerHTML=n.innerHTML,this.requestContentUpdate(!0,!1),this.actionHandler("ContentUpdated",!1,t)}newFile(){this.clear(),this.actionHandler("ContentUpdated",!1,"")}addShortcut(t,e){this.Shortcuts.set(t,e)}addHandler(t,e){this.ActionHandlers.set(t,e)}actionHandler(t,e=!1,...n){e||this.restoreRange();var r=this.ActionHandlers.get(t);if(!!r)return r(this,e,...n)}initialBlankContent(t=!1){this.Editor.innerHTML="<p><br/></p>",t&&this.Editor.querySelector("p").focus()}getLines(){return[].filter.call(this.Editor.children,t=>{if(t.tagName==="P")return!0})}getContent(){var t=[];for(let n of this.Editor.childNodes)if(!(!n.tagName&&n.nodeName!=="#text")){var e="";n.tagName!=="BR"&&(e=n.textContent||n.innerText),e!=null&&t.push(e.replace(/\n+/,""))}return t=t.join(`
`),t}optimizeContent(){var t=document.getSelection(),e=t.getRangeAt(0);if(!e)return[null,0,null,0,0,0];var n,r;if(e.collapsed)n="[["+newID()+"|OMNI]]",r=null,Editor.insertHTML(n);else{n="[["+newID()+"|START]]",r="[["+newID()+"|END]]";let g=document.createRange();g.setStart(e.endContainer,e.endOffset),g.setEnd(e.endContainer,e.endOffset),t.removeAllRanges(),t.addRange(g),Editor.insertHTML(r),g.setStart(e.startContainer,e.startOffset),g.setEnd(e.startContainer,e.startOffset),t.removeAllRanges(),t.addRange(g),Editor.insertHTML(n)}var a=document.createDocumentFragment();a.appendChild(newEle("div"));var i=a.firstChild,s=-1,l=-1,o=-1,d=-1,h=[];for(let g of this.Editor.childNodes)if(!(!g.tagName&&g.nodeName!=="#text")){var u="";g.tagName!=="BR"&&(u=g.textContent||g.innerText),u!=null&&h.push(u.replace(/\n+/,""))}h.forEach((g,b)=>{var x=newEle("p");if(g.length===0)x.innerHTML="<br>";else{x.innerText=g;let E=g.indexOf(n);E>=0&&(s=b,o=E),r&&(E=g.indexOf(r),E>=0&&(l=b,d=E))}i.appendChild(x)}),this.Editor.innerHTML!==i.innerHTML&&(this.Editor.innerHTML=i.innerHTML);var c=null,f=null,p=this.Editor.children;if(r)if(s>=0&&l>=s)c=p.item(s),f=p.item(l),c.innerText=c.textContent.replace(n,""),c.innerText===""&&(c.innerHTML="<br>"),f.innerText=f.innerText.replace(r,""),f.innerText===""&&(f.innerHTML="<br>"),s===l&&(d-=n.length);else return[null,0,null,0,0,0];else if(s>=0)c=p.item(s),c.innerText=c.textContent.replace(n,""),c.innerText===""&&(c.innerHTML="<br>"),f=c,d=o;else return[null,0,null,0,0,0];var m=c.childNodes.item(0),v=f.childNodes.item(0);try{e.setStart(m,o),e.setEnd(v,d),t.removeAllRanges(),t.addRange(e)}catch(g){return[c,0,f,0,s,l]}return[c,o,f,d,s,l]}onKeyDown(t){if(!this.imeOn&&![16,17,18,91].includes(t.which)){if(this.Editor.children.length===0&&this.initialBlankContent(!0),t.which===13){this.onEnter(t);return}var e=Editor.getKeyPair(t);this.Shortcuts.has(e)&&t.preventDefault()}}onKeyUp(t){if(!this.imeOn&&![16,17,18,91].includes(t.which)){var e=Editor.getKeyPair(t),n=this.Shortcuts.get(e);if(n&&this.actionHandler(n,!0)){t.preventDefault();return}["ESC","Up","Down","Left","Right"].indexOf(e)<0&&(this.contentChanged=!0,this.requestContentUpdate())}}onIMEStart(t){this.imeOn=!0}onIMEEnd(t){this.imeOn=!1}onDrop(t){this.actionHandler("Drop",!0,t)&&(this.contentChanged=!0,this.requestContentUpdate(),t.preventDefault())}onCopy(t){var e=document.getSelection(),n=e.getRangeAt(0);if(!n.collapsed){if(!!t.clipboardData&&!!t.clipboardData.setData){let a=[];for(let i of n.cloneContents().childNodes)a.push(i.textContent.replace(/\n/gi,""));a=a.join("<br>"),t.clipboardData.setData("text/html",a),t.preventDefault()}return}var r=Editor.getLineOfNode(n.startContainer);if(!!t.clipboardData&&!!t.clipboardData.setData){let a='<p class="newline">'+r.innerText+"</p>";t.clipboardData.setData("text/html",a)}else document.createRange().selectNode(r),document.execCommand("copy");t.preventDefault()}onCut(t){var e=document.getSelection(),n=e.getRangeAt(0);if(!n.collapsed){if(!!t.clipboardData&&!!t.clipboardData.setData){let a=[];for(let i of n.cloneContents().childNodes)a.push(i.textContent.replace(/\n/gi,""));a=a.join("<br>"),t.clipboardData.setData("text/html",a),Editor.insertHTML(""),this.contentChanged=!0,this.requestContentUpdate(!0),t.preventDefault()}return}var r=Editor.getLineOfNode(n.startContainer);if(!!t.clipboardData&&!!t.clipboardData.setData){let a='<p class="newline">'+r.innerText+"</p>";t.clipboardData.setData("text/html",a),this.Editor.removeChild(r)}else document.createRange().selectNode(r),document.execCommand("cut");this.contentChanged=!0,this.requestContentUpdate(!0),t.preventDefault()}onPaste(t){var e=!!this.actionHandler("Paste",!0,t);if(e){t.preventDefault();return}var n=!1,r=[],a=t.clipboardData.getData("text/html")||t.clipboardData.getData("text/plain")||t.clipboardData.getData("text");if(a.substr(0,1)==="<"){let g=new DocumentFragment;g.appendChild(newEle("div")),g.firstChild.innerHTML=a.replace(/\n+/g,""),[n,r]=Editor.getFragmentLines(g.firstChild)}else r=a.split(`
`);var[i,s,l,o]=this.optimizeContent(),d=l.innerText.substring(o),h=l.nextSibling,u=i,c=this.getLines(),f=c.indexOf(i),p=c.indexOf(l);for(let g=f+1;g<=p;g++)this.Editor.removeChild(c[g]);if(i.innerText=i.innerText.substring(0,s),n){let g=newEle("p"),b=r.shift();b.length>0?g.innerText=b:g.innerHTML="<br>",h?this.Editor.insertBefore(g,h):this.Editor.appendChild(g),i=g,s=0,u=g}else{let g=r.shift();i.innerText=i.innerText+g}if(r.forEach(g=>{g=g||"";var b=newEle("p");g.length>0?b.innerText=g:b.innerHTML="<br>",h?this.Editor.insertBefore(b,h):this.Editor.appendChild(b),u=b}),d.length>0)if(n){let g=newEle("p");g.innerText=d,o=0,h?this.Editor.insertBefore(g,h):this.Editor.appendChild(g),u=g}else{let g=u.innerText;g===`
`&&(g=""),o=g.length,u.innerText=g+d}else o=u.innerText.replace(/^\n+|\n+$/g,"").length;l=u,i=i.childNodes.item(0),l=l.childNodes.item(0);var m=document.getSelection(),v=document.createRange();v.setStart(i,s),v.setEnd(l,o),m.removeAllRanges(),m.addRange(v),this.contentChanged=!0,this.requestContentUpdate(),t.preventDefault()}onEnter(t){if(t.ctrlKey||t.altKey||t.shiftKey||t.metaKey){t.preventDefault();return}}onEdited(t=!0){if(!this.imeOn&&(this.tmrChanger&&clearTimeout(this.tmrChanger),this.tmrChanger=null,!!this.contentChanged)){var[e,n,r,a]=this.optimizeContent(),i=this.getContent();if(i!==this.lastContent&&(this.lastContent=i,this.contentChanged=!1,this.actionHandler("ContentUpdated",!1,i),!!t)){var s=this.getLines();e=s.indexOf(e),r=s.indexOf(r),this.Memory.add(i,e,n,r,a)}}}onBlur(t){var e=document.getSelection();this.lastRange=e.getRangeAt(0)}onWheel(t){this.actionHandler("Scroll",!0,t)}recallMemory(t=!0){this.requestContentUpdate(!0,!0);var e=t?this.Memory.undo():this.Memory.redo();if(!e)return!0;var[n,r,a,i,s]=e,l=document.createDocumentFragment();l.appendChild(newEle("div"));var o=l.firstChild;if(n.split(`
`).forEach((u,c)=>{var f=newEle("p");u.length===0?f.innerHTML="<br>":f.innerText=u,o.appendChild(f)}),this.Editor.innerHTML=o.innerHTML,r=this.Editor.children.item(r),!r||(r=r.childNodes.item(0),!r)||(i=this.Editor.children.item(i),!i)||(i=i.childNodes.item(0),!i))return!0;var d=document.getSelection(),h=document.createRange();return h.setStart(r,a),h.setEnd(i,s),d.removeAllRanges(),d.addRange(h),this.requestContentUpdate(!0,!1),!0}requestContentUpdate(t=!1,e=!0){this.tmrChanger&&clearTimeout(this.tmrChanger),t?(this.tmrChanger=null,this.onEdited(e)):this.tmrChanger=setTimeout(()=>this.onEdited(e),1e3)}blockIndent(t,e=!0){var[n,r,a,i]=this.optimizeContent(),s=n===a&&r===i;if(s)if(e)Editor.insertHTML("	");else{let l=n.innerText,o=l.substring(0,r),d=l.substring(r,l.length);if(o.substring(o.length-1,o.length)==="	"){o=o.substring(0,o.length-1),l=o+d,n.innerText=l;let u=document.getSelection(),c=document.createRange();n=n.childNodes.item(0),c.setStart(n,r-1),c.setEnd(n,r-1),u.removeAllRanges(),u.addRange(c)}}else{let l=!1;this.getLines().forEach(h=>{if(h===n&&(l=!0),!l)return;let u=h.childNodes.item(0);if(!!u&&u.tagName!=="BR"){let c=h.innerText;e?c="	"+c:c=c.replace(/^\t/,""),h.innerText=c}h===a&&(l=!1)}),n=n.childNodes.item(0),a=a.childNodes.item(0);let o=document.getSelection(),d=document.createRange();d.setStart(n,0),d.setEnd(a,(a.textContent||"").length),o.removeAllRanges(),o.addRange(d)}return this.requestContentUpdate(!0,!0),!0}moveBlock(t,e=!0){var[n,r,a,i]=this.optimizeContent(),s=this.getLines(),l=s.indexOf(n),o=s.indexOf(a);if(l<0||o<0||l===0&&e||o===s.length-1&&!e)return!1;var d,h;if(e){if(d=s[l-1],!d)return!1;h=s[o+1],h?this.Editor.insertBefore(d,h):this.Editor.appendChild(d)}else{if(d=s[o+1],!d)return!1;h=s[l],this.Editor.insertBefore(d,h)}n=n.childNodes.item(0),a=a.childNodes.item(0);var u=document.getSelection(),c=document.createRange();return c.setStart(n,0),c.setEnd(a,(a.textContent||"").length),u.removeAllRanges(),u.addRange(c),this.requestContentUpdate(!0,!0),!0}insertNewLine(){var[t,e,n,r]=this.optimizeContent();if(!(!t||!n)){var a=document.getSelection(),i=a.getRangeAt(0),s=t.previousSibling;if(!!s){var l=s.textContent.replace(/^\n+|\n+$/g,""),o=l.match(this.LineHeadPrefix);if(!(!o||o[0].length===0)){if(o=o[0],l===o)this.Editor.removeChild(s),i.setStart(t,0),i.setEnd(t,0);else{let d=t.textContent.replace(/^\n+|\n+$/g,"");t.innerText=o+d,t=t.childNodes.item(0),i.setStart(t,o.length),i.setEnd(t,o.length)}return a.removeAllRanges(),a.addRange(i),this.requestContentUpdate(!0,!0),!0}}}}insertBlock(t,e,n,r,a,i){n||([n,r,a,i]=this.optimizeContent());var s=a.textContent;s=s.substring(i);var l=n.textContent.substring(0,r);l.length===0?n.innerHTML="<br>":n.innerText=l;var o=this.getLines(),d=o.indexOf(n),h=o.indexOf(a);for(let p=d+1;p<=h;p++)this.Editor.removeChild(o[p]);var u=a.nextElementSibling;if(!u)u=newEle("p"),s.length===0?u.innerHTML="<br>":u.innerText=s,this.Editor.appendChild(u);else{let p=newEle("p");s.length===0?p.innerHTML="<br>":p.innerText=s,this.Editor.insertBefore(p,u),u=p}s=newEle("p"),s.innerHTLM="<br>",this.Editor.insertBefore(s,u),String.is(t)&&(t=[t]),t.forEach((p,m)=>{var v=newEle("p");p.length===0?v.innerHTML="<br>":v.innerText=p,this.Editor.insertBefore(v,u),m===0&&(n=v),a=v}),s=newEle("p"),s.innerHTLM="<br>",this.Editor.insertBefore(s,u);var c=document.getSelection(),f=document.createRange();return n=n.childNodes.item(0),a=a.childNodes.item(0),f.setStart(n,0),f.setEnd(a,a.textContent.length),c.removeAllRanges(),c.addRange(f),e&&(this.contentChanged=!0,this.requestContentUpdate(!0)),!0}restoreRange(){if(!!this.lastRange){var t=document.getSelection();try{t.removeAllRanges(),t.addRange(this.lastRange)}catch(e){}this.lastRange=null}}static insertHTML(t){document.execCommand("insertHTML",!1,t)}static getLineOfNode(t){if(t.tagName==="P")return t;var e=document.body;for(t=t.parentElement;t&&t.tagName!=="P";){if(t===e){t=null;break}t=t.parentElement}return t}static getLinePosition(t,e,n=0){if(!t.childNodes)return n;var r=0;for(let a of t.childNodes){if(a===e)return r+=n,[!0,r];if(a.nodeName==="#text")r+=a.textContent.length;else{let[i,s]=Editor.getLinePosition(a,e,n);if(r+=s,i)return[!0,r]}}return[!1,r]}static getKeyPair(t){var e=[];t.ctrlKey&&e.push("ctrl"),t.altKey&&e.push("alt"),t.shiftKey&&e.push("shift"),t.winKey&&e.push("win"),t.metaKey&&e.push("meta");var n=t.key;return n.indexOf("Arrow")>=0?n=n.replace("Arrow",""):t.which===27?n="Esc":t.which===8?n="Back":t.which===9?n="Tab":t.which===13?n="Enter":n=n.toUpperCase(),e.push(n),e=e.join("+"),e}static getFragmentLines(t){var e=[],n=[],r=!1;for(let i of t.childNodes){let s=i.nodeName;if(s==="#text"){let l=i.textContent;if(l=l.replace(/^\n+|\n+$/g,""),l.length===0)continue;l=l.split(`
`),l.forEach((o,d)=>{n.push(o),d<l.length-1&&n.length>0&&(e.push(n),n=[])})}else{if(s.indexOf("#")>=0)continue;if(s==="STYLE"||s==="SCRIPT")continue;if(s==="BR")e.push(n),n=[];else if(BlockLevelTags.indexOf(s)>=0){r=!0,n.length>0&&e.push(n);let l=!i.classList.contains("newline");l&&e.push([]),n=[],Editor.getFragmentLines(i)[1].forEach(o=>e.push(o)),l&&e.push([])}else n.push(i.innerText)}}n.length>0&&e.push(n),e=e.map(i=>Array.is(i)?i.join(""):i);var a=!1;return e=e.filter(i=>(i=i||"",i.length>0?(a=!1,!0):a?!1:(a=!0,!0))),[r,e]}}class MarkupEditor extends Editor{constructor(t){super(t);this.LineHeadPrefix=/^([ 　\t>\+\*~]|\d+\.[ 　\t]+|\-[ 　\t]+)+/,this.title="untitled",this.filename="",this.lineMap=[],this.tmrScroll=null,this.notAutoUpdateContent=!1,this.Preview=String.is(t.ui.preview)?document.querySelector(t.ui.preview):t.ui.preview,this.addHandler("ContentUpdated",(e,n,r)=>{if(this.notAutoUpdateContent)return!0;r=r.split(`
`);var a=!1,i="";return this.lineMap.splice(0,this.lineMap.length),r=r.map((s,l)=>{var o=!1;if([o,a,i]=MarkupEditor.notTextLine(s,a,i),o)return s;var d=s.match(/^([ 　`~!@#%^&\*\-_\+=\\\|:;\/\?\.,<>\d\r\t]|(\[\w*\][ 　\t]*(\(.*\))*)|\{[\|<>]*\})*/);d?d=d[0]:d="";var h=s.substring(0,d.length),u=s.substring(d.length,s.length);return d="%LINENUMBER-"+l+"%",this.lineMap.push(l),h+d+u}),r=r.join(`
`),this.markupDoc(r),!0}),this.addHandler("Scroll",e=>{this.tmrScroll&&clearTimeout(this.tmrScroll),this.tmrScroll=setTimeout(()=>this.onScrolled(),100)}),this.addHandler("bold",e=>this.togglePair("**")),this.addHandler("italic",e=>this.togglePair("*")),this.addHandler("underline",e=>this.togglePair("__")),this.addHandler("wavy",e=>this.togglePair("~")),this.addHandler("throughLine",e=>this.togglePair("~~")),this.addHandler("sub",e=>this.togglePair("_")),this.addHandler("sup",e=>this.togglePair("^")),this.addHandler("red",e=>this.changeColor("red")),this.addHandler("green",e=>this.changeColor("green")),this.addHandler("blue",e=>this.changeColor("blue")),this.addHandler("yellow",e=>this.changeColor("yellow")),this.addHandler("gold",e=>this.changeColor("gold")),this.addHandler("white",e=>this.changeColor("white")),this.addHandler("silver",e=>this.changeColor("silver")),this.addHandler("gray",e=>this.changeColor("gray")),this.addHandler("dark",e=>this.changeColor("dark")),this.addHandler("black",e=>this.changeColor("black")),this.addHandler("sizeUp",e=>this.changeSize(!0)),this.addHandler("sizeDown",e=>this.changeSize(!1)),this.addHandler("footnote",e=>this.generateMark("\u811A\u6CE8","footnote")),this.addHandler("endnote",e=>this.generateMark("\u5C3E\u6CE8","endnote")),this.addHandler("term",e=>this.generateMark("\u672F\u8BED","term")),this.addHandler("anchor",e=>this.generateMark("\u951A\u70B9","anchor")),this.addHandler("convert-code",e=>this.togglePair("`")),this.addHandler("convert-latex",e=>this.togglePair("$")),this.addHandler("insert-icon",e=>this.generateIcon());for(let e=1;e<=6;e++)this.addHandler("heading-"+e,n=>this.toggleHeader(e));QuoteTypes.forEach(e=>{this.addHandler("quote-"+e,n=>this.toggleQuote(e))}),["ol","ul"].forEach(e=>{this.addHandler("list-"+e,n=>this.toggleList(e))}),this.addHandler("insert-table",e=>this.generateTable()),this.addHandler("insert-code",e=>this.insertCodeBlock()),this.addHandler("insert-latex",e=>this.insertLaTeX()),["left","center","right"].forEach(e=>{this.addHandler("align-"+e,n=>this.toggleAlign(e))}),["indent","outdent"].forEach(e=>{this.addHandler(e,n=>this.toggleIndent(e))}),["link","image","video","audio"].forEach(e=>{this.addHandler("insert-"+e,n=>this.generateLink(e))}),["normal","double","dotted","dashed","gradient","wavy","star"].forEach(e=>{this.addHandler("headline-"+e,n=>this.insertHeadLine(e))}),this.addHandler("insert-block",e=>this.generateRefBlock()),this.addHandler("Paste",(e,n,r)=>{var a=r.clipboardData.getData("text/html");return a?(MarkUp.reverse(a).then(i=>{e.insertBlock(i.split(`
`),!0)}),!0):!1})}clear(){this.title="untitled",this.filename="",super.clear()}read(t){this.Memory.reset(t),this.lastContent=t,this.contentChanged=!1;var e=document.createDocumentFragment();e.appendChild(newEle("div"));var n=e.firstChild;t.split(`
`).forEach((r,a)=>{var i=newEle("p");r.length===0?i.innerHTML="<br>":i.innerText=r,n.appendChild(i)}),this.Editor.innerHTML=n.innerHTML,this.requestContentUpdate(!0,!1),this.actionHandler("ContentUpdated",!1,t)}newFile(t){this.clear();var e=["\u6807\u9898\uFF1A\u65B0\u6587\u6863"];t&&e.push("\u4F5C\u8005\uFF1A"+t),e.push("\u66F4\u65B0\uFF1A"+timeNormalize(new Date)),e.push("\u5173\u952E\u8BCD\uFF1A\u672A\u5206\u7C7B"),e.push(""),e.push("");var n=e.join(`
`),r="<p>"+e.map(a=>a||"<br>").join("</p><p>")+"</p>";this.Editor.innerHTML=r,this.Memory.reset(n),this.lastContent=n,this.contentChanged=!1,this.actionHandler("ContentUpdated",!1,n)}read(t,e){this.filename=t,this.title=t.replace(/\.m[ud]$/i,""),super.read(e)}getBlocks(t,e){var n=this.getLines(),r=n.indexOf(t),a=n.indexOf(e),i=t.textContent;if(i){for(let o=r-1;o>=0;o--)if(!n[o].textContent){r=o+1;break}}else{let o=!1;for(let d=r+1;d<=a;d++)if(n[d].textContent){o=!0,r=d;break}if(!o)return[[],0,0]}if(i=e.textContent,i){for(let o=a+1;o<n.length;o++)if(!n[o].textContent){a=o-1;break}}else{let o=!1;for(let d=a-1;d>=r;d--)if(n[d].textContent){o=!0,a=d;break}if(!o)return[[],0,0]}var s=[],l=[];for(let o=r;o<=a;o++){let d=n[o];d.textContent?l.push(d):l.length>0&&(s.push(l),l=[])}return l.length>0&&s.push(l),[s,r,a]}insertNewLine(){var[t,e,n,r]=this.optimizeContent();if(!(!t||!n)){var a=document.getSelection(),i=a.getRangeAt(0),s=t.previousSibling;if(!!s){var l=s.textContent.replace(/^\n+|\n+$/g,""),o=l.match(this.LineHeadPrefix);if(!(!o||o[0].length===0)){if(o=o[0],l===o)this.Editor.removeChild(s),i.setStart(t,0),i.setEnd(t,0);else{o=o.replace(/(\d+)\.([ 　\t]+)$/,(h,u,c)=>u*1+1+"."+c);let d=t.textContent.replace(/^\n+|\n+$/g,"");t.innerText=o+d,t=t.childNodes.item(0),i.setStart(t,o.length),i.setEnd(t,o.length)}return a.removeAllRanges(),a.addRange(i),this.requestContentUpdate(!0,!0),!0}}}}togglePair(t,e){if(!t)return!1;e=e||t;var[n,r,a,i]=this.optimizeContent();if(n!==a)return!1;var s=n.textContent,l=s.substring(0,r+t.length),o=!1,d=-1,h=-1;if(t===e){let f=MarkupEditor.getAllPartsInLine(t,l);f.length>f.length>>1<<1&&(d=f[f.length-1][0])}else{let f=MarkupEditor.getAllPartsInLine(t,l);l=s.substring(0,r);let p=MarkupEditor.getAllPartsInLine(e,l);f.length>p.length&&(d=f[f.length-1][0])}if(d>=0)if(l=s.substring(d+t.length),h=l.indexOf(e),h>=0){let f=l.indexOf(t);f<0||f>=h?(o=!0,h+=d+t.length):(d=-1,h=-1)}else d=-1;if(o){let f=s.substring(0,d),p=s.substring(d+t.length,h),m=s.substring(h+e.length);s=f+p+m,r=d,i=h-t.length}else{let f=s.substring(0,r),p=s.substring(r,i),m=s.substring(i);s=f+t+p+e+m,i+=t.length+e.length}n.innerText=s,s=n.childNodes.item(0);var u=document.getSelection(),c=document.createRange();return c.setStart(s,r),c.setEnd(s,i),u.removeAllRanges(),u.addRange(c),this.contentChanged=!0,this.requestContentUpdate(!0),!0}changeColor(t){if(!!t&&(t=t.toLowerCase(),!!AvailableColors.includes(t))){var[e,n,r,a]=this.optimizeContent();if(e!==r)return!1;var i=e.textContent,s=!1,l=-1,o=-1,d=null;t="["+t+"]";var h=i.substring(0,a+ColorTailMark.length),u=MarkupEditor.getAllPartsInLine(ColorHeadMarkReg,h);h=i.substring(0,n);var c=MarkupEditor.getAllPartsInLine(ColorTailMark,h);if(u.length>c.length&&(l=u[u.length-1],d=l[1],l=l[0]),l>=0)if(h=i.substring(l+d.length),o=h.indexOf(ColorTailMark),o>=0){let m=h.match(ColorHeadMarkReg);!m||m.index>=o?(s=!0,o+=l+d.length):(l=-1,o=-1)}else l=-1;if(s)if(d===t){let m=i.substring(0,l),v=i.substring(l+d.length,o),g=i.substring(o+ColorTailMark.length);i=m+v+g,n=l,a=o-d.length}else{let m=i.substring(0,l),v=i.substring(l+d.length,o),g=i.substring(o+ColorTailMark.length);i=m+t+v+ColorTailMark+g,n=l,a=o-d.length+t.length+ColorTailMark.length}else{let m=i.substring(0,n),v=i.substring(n,a),g=i.substring(a);i=m+t+v+ColorTailMark+g,a+=t.length+ColorTailMark.length}e.innerText=i,i=e.childNodes.item(0);var f=document.getSelection(),p=document.createRange();return p.setStart(i,n),p.setEnd(i,a),f.removeAllRanges(),f.addRange(p),this.contentChanged=!0,this.requestContentUpdate(!0),!0}}changeSize(t=!0){var[e,n,r,a]=this.optimizeContent();if(e!==r)return!1;var i=e.textContent,s=0,l=-1,o=-1,d=0,h=0,u=i.substring(n).match(/[^\^]/);u?u=u.index:u=0;var c=i.substring(0,n+u),f=MarkupEditor.getAllPartsInLine(/\^{2,}/g,c);if(f.length>>1<<1!==f.length&&(l=f.last,d=l[1].length,l=l[0]),l>=0&&(c=i.substring(l+d),o=c.match(/\^{2,}/),o?(h=o[0].length,o=o.index+l+d):(l=-1,d=0)),s=Math.min(d,h),s===0&&!t||s>=5&&t)return!0;s>5&&(s=5),(l<0||o<0)&&(l=n,o=a),t?(s++,s>5&&(s=5),s<2&&(s=2)):(s--,s>5&&(s=5),s<2&&(s=0));var p=String.blank(s,"^"),m=i.substring(0,l),v=i.substring(l+d,o),g=i.substring(o+h);i=m+p+v+p+g,n=l,a=l+v.length+2*s,e.innerText=i,i=e.childNodes.item(0);var b=document.getSelection(),x=document.createRange();return x.setStart(i,n),x.setEnd(i,a),b.removeAllRanges(),b.addRange(x),this.contentChanged=!0,this.requestContentUpdate(!0),!0}generateMark(t,e){var[n,r,a,i]=this.optimizeContent();if(n!==a)return!1;var s=document.getSelection(),l=s.getRangeAt(0);return showInfobox({title:"\u63D2\u5165"+t,input:!0,action:"oc",callback:(o,d,h)=>{this.lastRange=null,s.removeAllRanges(),s.addRange(l),l=null,!(o==="cancel"||!d)&&this.insertMark(e,d,n,r,a,i)}}),!0}insertMark(t,e,n,r,a,i){if(!!e){if(!n&&([n,r,a,i]=this.optimizeContent(),n!==a))return!1;var s=n.textContent,l=s.substring(0,r),o=s.substring(r,i),d=s.substring(i),h="",u="",c=0,f=0;if(!!o&&o.length>0&&(h="["+o+"]"),t==="footnote"?(u="[:"+e+"]",c=2,f=1):t==="endnote"?(u="[^"+e+"]",c=2,f=1):(u="{"+e+"}",c=1,f=1),s=l+h+u+d,n.innerText=s,t==="anchor")r=l.length+h.length+c,i=r+e.length;else{let v=newEle("p"),g=newEle("p"),b="["+e+"]: ";v.innerHTML=b,g.innerHTML="<br>";let x=n.nextSibling;x?this.Editor.insertBefore(g,x):this.Editor.appendChild(g),this.Editor.insertBefore(v,g),n=v,r=b.length,i=r}var p=document.getSelection(),m=document.createRange();n=n.childNodes.item(0),m.setStart(n,r),m.setEnd(n,i),p.removeAllRanges(),p.addRange(m),this.contentChanged=!0,this.requestContentUpdate(!0)}}generateIcon(){var[t,e,n,r]=this.optimizeContent();if(t!==n)return!1;var a=document.getSelection(),i=a.getRangeAt(0);return showInfobox({title:"\u63D2\u5165 FontAwesome \u56FE\u6807",input:!0,action:"oc",callback:(s,l,o)=>{this.lastRange=null,a.removeAllRanges(),a.addRange(i),i=null,!(s==="cancel"||!l)&&this.insertIcon(l,t,e,n,r)}}),!0}insertIcon(t,e,n,r,a){if(!!t){if(!e&&([e,n,r,a]=this.optimizeContent(),e!==r))return!1;var i=e.textContent,s=i.substring(0,n),l=i.substring(a),o=" :"+t+": ";e.innerText=s+o+l;var d=document.getSelection(),h=document.createRange();e=e.childNodes.item(0),h.setStart(e,s.length),h.setEnd(e,s.length+o.length),d.removeAllRanges(),d.addRange(h),this.contentChanged=!0,this.requestContentUpdate(!0)}}generateTable(){var[t,e,n,r]=this.optimizeContent(),a=document.getSelection(),i=a.getRangeAt(0),s='<div class="table-generator" style="text-align:center;">';return s+='<div class="table-line">\u884C\uFF1A<input class="number-inputter row-count" type="number" value=2></div>',s+='<div class="table-line">\u5217\uFF1A<input class="number-inputter col-count" type="number" value=2></div>',s+="</div>",showInfobox({title:"\u63D2\u5165\u8868\u683C",mode:"html",content:s,input:!1,action:"oc",callback:(l,o,d)=>{if(this.lastRange=null,a.removeAllRanges(),a.addRange(i),i=null,l!=="cancel"){var h=d.$refs.content,u=h.querySelector("input.row-count"),c=h.querySelector("input.col-count");this.insertTable(u.value||2,c.value||2,t,e,n,r)}}}),!0}insertTable(t,e,n,r,a,i){if(!(!(t>0)||!(e>0))){var s=[],l=[];for(let o=1;o<=e;o++)l.push("\u6807\u9898"+o);s.push(l.join("|")),l=[];for(let o=0;o<e;o++)l.push("-");s.push(l.join("|"));for(let o=0;o<t;o++){l=[];for(let d=0;d<e;d++)l.push("  ");s.push(l.join("|"))}this.insertBlock(s,!0,n,r,a,i)}}toggleHeader(t){if(!(t>=0&&t<=6))return!1;var[e,n,r,a]=this.optimizeContent();if(e!==r)return!1;var i=!1,s=0,l=e.textContent;if(!l)return!1;if(l.match(/^(\-{3,}|={3,}|\+{3,}|_{3,}|\*{3,}|#{3,}|\.{3,})$/)){let h=l.substring(0,1),u=HeaderLevel[h]||0;if(e=e.previousSibling,!e||(l=e.textContent,!l||l.match(/^[ 　\t\-=\+\*>`\$#]*$/)))return!1;let c=l.match(/^#+/);!!c&&!!c[0]&&c[0].length>0?c=7-c[0].length:c=0,s=Math.max(u,c),i=!0}else{let h=l.match(/^#+/);!!h&&!!h[0]&&h[0].length>0?h=7-h[0].length:h=0;let u=e.nextSibling;if(u)if(u.textContent.match(/^(\-{3,}|={3,}|\+{3,}|_{3,}|\*{3,}|#{3,}|\.{3,})$/)){i=!0;let f=l.substring(0,1),p=HeaderLevel[f]||0;s=Math.max(h,p),r=u}else s=h;else s=h}if(s>0&&(s=7-s),s===t){if(t===0)return!1;t=0}i&&this.Editor.removeChild(r),l=e.textContent.replace(/^#+[ 　\t]*/,""),e.innerText=String.blank(t,"#")+(t>0?" ":"")+l,n=t,t>0&&n++,a=n+l.length;var o=document.getSelection(),d=document.createRange();return e=e.childNodes.item(0),d.setStart(e,n),d.setEnd(e,a),o.removeAllRanges(),o.addRange(d),this.contentChanged=!0,this.requestContentUpdate(!0),!0}toggleQuote(t){t&&QuoteTypes.includes(t)||(t="quote");var[e,n,r,a]=this.optimizeContent(),[i,s,l]=this.getBlocks(e,r),o=[],d=!0;if(i.forEach(f=>{var p=f[0].textContent,m="",v=p.match(/^( |　|\t)+/);v?m="quote":(v=p.match(/^([ 　\t\-\/\*>]|\d+\.)*>[ 　\t]*(\[(\w+)\])*[ 　\t]*/),v&&(m=v[3],m?(m=m.toLowerCase(),QuoteTypes.includes(m)||(m="quote")):m="quote")),o.push(m)}),o.some(f=>{if(f!==o[0])return d=!1,!0}),d&&o[0]===t)i.forEach(f=>{f.forEach(p=>{var m=p.textContent,v=!1;m=m.replace(/^( |　|\t)+/,()=>(v=!0,"")),v||(m=m.replace(/^(([ 　\t\-\/\*>]|\d+\.)*)>[ 　\t]*(\[(\w+)\])*[ 　\t]*/,(g,b)=>b)),p.innerText=m})});else{let f=">	";t!=="quote"&&(f+="["+t+"]	"),i.forEach(p=>{p.forEach((m,v)=>{var g=m.textContent,b=!1;v===0?(g=g.replace(/^( |　|\t)+/,()=>(b=!0,f)),b||(g=g.replace(/^(([ 　\t\-\/\*>]|\d+\.)*)>[ 　\t]*(\[(\w+)\])*[ 　\t]*/,(x,E)=>(b=!0,(E||"")+f))),b||(g=f+g)):(g=g.replace(/^( |　|\t)+/,()=>(b=!0,"")),b||(g=g.replace(/^(([ 　\t\-\/\*>]|\d+\.)*)>[ 　\t]*(\[(\w+)\])*[ 　\t]*/,(x,E)=>E||""))),m.innerText=g})})}e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var h=r.textContent,u=document.getSelection(),c=document.createRange();return c.setStart(e,0),c.setEnd(r,h.length),u.removeAllRanges(),u.addRange(c),this.contentChanged=!0,this.requestContentUpdate(!0),!0}toggleList(t){if(t!=="ul"&&t!=="ol")return!1;var[e,n,r,a]=this.optimizeContent(),[i,s,l]=this.getBlocks(e,r);const o=/^(([ 　\t>]|\d+\.[ 　\t]|[\-\+\*][ 　\t])*)(([\-\+\*]|\d+\.)[ 　\t])/,d=/^(([ 　\t>]|\d+\.[ 　\t]|[\-\+\*][ 　\t])*)(([\-\+\*]|\d+\.)[ 　\t])*/;var h=[],u=!0;i.forEach(m=>{var v="";m.forEach(g=>{var b=g.textContent,x="",E=b.match(o);!!E&&!!E[3]?(E[3].match(/^[\-\+\*]/)?x="ul":x="ol",v=x):x=v,h.push(x)})}),h.some(m=>{if(m!==h[0])return u=!1,!0}),u&&h[0]===t?i.forEach(m=>{m.forEach(v=>{var g=v.textContent;g=g.replace(o,(b,x)=>x||""),v.innerText=g})}):i.forEach(m=>{m.forEach((v,g)=>{var b=v.textContent,x=!1,E=t==="ol"?g+1+".	":"-	";b=b.replace(d,(w,T)=>(x=!0,(T||"")+E)),x||(b=E+b),v.innerText=b})}),e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var c=r.textContent,f=document.getSelection(),p=document.createRange();return p.setStart(e,0),p.setEnd(r,c.length),f.removeAllRanges(),f.addRange(p),this.contentChanged=!0,this.requestContentUpdate(!0),!0}insertCodeBlock(){var t=[];return t.push("``` javascript"),t.push("codes here..."),t.push("```"),this.insertBlock(t,!0)}insertLaTeX(){var t=[];return t.push("$$"),t.push("latex equation here..."),t.push("$$"),this.insertBlock(t,!0)}toggleAlign(t){t!=="center"&&t!=="right"&&(t="left");var[e,n,r,a]=this.optimizeContent(),[i,s,l]=this.getBlocks(e,r),o=[],d=!0;if(i.forEach(f=>{var p=f.first.textContent,m="",v=p.match(/^( |　|\t|>|\-|\+|\*|~|\d+\.)*\{([<\|>])\}/);if(!!v&&!!v[2]){let g=v[2];g==="<"?m="left":g==="|"?m="center":g===">"&&(m="right")}else m="left";o.push(m)}),o.some(f=>{if(f!==o[0])return d=!1,!0}),d&&o[0]===t)i.forEach(f=>{var p=f.first,m=p.textContent;m=m.replace(/^(( |　|\t|>|\-|\+|\*|~|\d+\.)*)\{[<\|>]\}[ 　\t]*/,(v,g)=>g||""),p.innerText=m});else{let f="";t==="center"?f="{|}	":t==="right"&&(f="{>}	"),i.forEach(p=>{var m=p.first,v=m.textContent;v=v.replace(/^(( |　|\t|>|\-|\+|\*|~|\d+\.)*)(\{[<\|>]\}[ 　\t]*)*/,(g,b)=>(b||"")+f),m.innerText=v})}e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var h=r.textContent,u=document.getSelection(),c=document.createRange();return c.setStart(e,0),c.setEnd(r,h.length),u.removeAllRanges(),u.addRange(c),this.contentChanged=!0,this.requestContentUpdate(!0),!0}toggleIndent(t){if(t!=="indent"&&t!=="outdent")return!1;var[e,n,r,a]=this.optimizeContent(),[i,s,l]=this.getBlocks(e,r);i.forEach(u=>{var c=u.first.textContent,f="";c=c.replace(/^(( |　|\t|>|\-|\+|\*|~|\d+\.|\{[<\|>]\})*)(:*)([ 　\t]*)/,(p,m,v,g,b)=>(m=m||"",g=g||"",b=b||"",t==="outdent"?g.length>0?g=g.substring(1):(g="",b=""):(g=g+":",b=b||" "),m+g+b)),u.first.innerText=c}),e=i.first.first.childNodes.item(0),r=i.last.last.childNodes.item(0);var o=r.textContent,d=document.getSelection(),h=document.createRange();return h.setStart(e,0),h.setEnd(r,o.length),d.removeAllRanges(),d.addRange(h),this.contentChanged=!0,this.requestContentUpdate(!0),!0}generateLink(t){var[e,n,r,a]=this.optimizeContent();if(e!==r)return!1;var i=document.getSelection(),s=i.getRangeAt(0),l=e.textContent||"",o=l.substring(n,a),d='<div class="link-generator" style="text-align:center;">';d+='<div class="link-line">\u6807\u9898\uFF1A<input class="number-inputter link-title" value="'+o+'"></div>',d+='<div class="link-line">\u5730\u5740\uFF1A<input class="number-inputter link-address" value=""></div>';var h="\u8D85\u94FE\u63A5",u='<div class="link-line button-line" style="margin-top:10px;font-size:14px;">';return u+='<input type="radio" name="position" value="nextline" checked><span class="name">\u72EC\u7ACB\u4E00\u884C</span><br>',u+='<input type="radio" name="position" value="floatleft"><span class="name">\u5DE6\u4FA7\u6DF7\u6392</span><br>',u+='<input type="radio" name="position" value="floatright"><span class="name">\u53F3\u4FA7\u6DF7\u6392</span>',u+="</div>",t==="image"?(h="\u56FE\u7247",d+=u):t==="video"?(h="\u89C6\u9891",d+=u):t==="audio"&&(h="\u97F3\u9891",d+=u),d+="</div>",showInfobox({title:"\u63D2\u5165"+h,mode:"html",content:d,input:!1,action:"oc",callback:(c,f,p)=>{if(this.lastRange=null,i.removeAllRanges(),i.addRange(s),s=null,c!=="cancel"){var m=p.$refs.content,v=m.querySelector("input.link-address").value;if(!!v){var g=m.querySelector("input.link-title").value,b="nextline";m.querySelectorAll('input[type="radio"][name="position"]').forEach(x=>{x.checked&&(b=x.value)}),this.insertLink(t,g,v,b,e,n,r,a)}}}}),!1}insertLink(t,e,n,r,a,i,s,l){a||([a,i,s,l]=this.optimizeContent());var o=a.textContent,d=o.substring(0,i),h=o.substring(i,l),u=o.substring(l),c="["+e+"]("+n,f=!1;t==="image"?(c="!"+c,f=!0):t==="image"?(c="@"+c,f=!0):t==="image"&&(c="#"+c,f=!0),f?r==="floatleft"?c+=' "left")':r==="floatright"?c+=' "right")':c+=")":c+=")";var p=document.getSelection(),m=document.createRange();a.innerText=d+c+u,i=d.length,l=i+c.length,a=a.childNodes.item(0),m.setStart(a,i),m.setEnd(a,l),p.removeAllRanges(),p.addRange(m)}insertHeadLine(t){var[e,n,r,a]=this.optimizeContent(),i="---";return t==="double"?i="===":t==="dotted"?i="...":t==="dashed"?i="___":t==="gradient"?i="+++":t==="wavy"?i="~~~":t==="star"&&(i="***"),this.insertBlock(i,!0,e,n,r,a),!0}generateRefBlock(){var[t,e,n,r]=this.optimizeContent();if(t!==n)return!1;var a=document.getSelection(),i=a.getRangeAt(0),s=t.textContent||"";s=s.substring(e,r);var l='<div class="table-generator" style="text-align:center;">';return l+='<div class="table-line">\u540D\u79F0\uFF1A<input class="number-inputter block-name" value=""></div>',l+="</div>",showInfobox({title:"\u63D2\u5165\u5F15\u7528\u5757",mode:"html",content:l,input:!1,action:"oc",callback:(o,d,h)=>{if(this.lastRange=null,a.removeAllRanges(),a.addRange(i),i=null,o!=="cancel"){var u=h.$refs.content,c=u.querySelector("input.block-name").value;!c||this.insertRefBlock(c,s,t,e,n,r)}}}),!1}insertRefBlock(t,e,n,r,a,i){n||([n,r,a,i]=this.optimizeContent());var s=n.textContent,l=s.substring(0,r);e=e||s.substring(r,i);var o=s.substring(i),d="["+t+"]";n.innerText=l+d+o;var h=this.getBlocks(n,n)[0][0];if(n=h.last,a=n.nextElementSibling,d="[:"+t+":]",a){let f=newEle("p");f.innerHTML="<br>",this.Editor.insertBefore(f,a),n=newEle("p"),n.innerText=d+e+d,this.Editor.insertBefore(n,a)}else{let f=newEle("p");f.innerHTML="<br>",this.Editor.appendChild(f),n=newEle("p"),n.innerText=d+e+d,this.Editor.appendChild(n)}var u=document.getSelection(),c=document.createRange();r=d.length,i=r+e.length,n=n.childNodes.item(0),c.setStart(n,r),c.setEnd(n,i),u.removeAllRanges(),u.addRange(c)}onScrolled(){if(this.tmrScroll&&(clearTimeout(this.tmrScroll),this.tmrScroll=null),!(this.Editor.parentNode.scrollHeight<=this.Editor.parentNode.offsetHeight)){var t=this.Editor.parentNode.scrollTop/(this.Editor.parentNode.scrollHeight-this.Editor.parentNode.offsetHeight),e=this.Editor.parentNode.getBoundingClientRect();e=e.top+e.height*t;var n=[].map.call(this.Editor.childNodes,d=>d),r=-1,a=!0,i=!1;n.some((d,h)=>{if(!d.getBoundingClientRect)return a&&r++,a=!1,i=!0,!1;a?r++:a=!0,i=!1;var u=d.getBoundingClientRect();return u.top>=e}),i||r--;var s,l,o;if(this.lineMap.some(d=>{if(d<r&&(s=d),d===r&&(l=d),d>r)return o=d,!0}),l>=0){if(l=this.getTargetNode(l),!l)return;l=l.getBoundingClientRect();let d=l.top-this.Preview.getBoundingClientRect().top,h=this.Editor.parentElement;if(h.scrollHeight>h.offsetHeight){let u=h.scrollTop/(h.scrollHeight-h.offsetHeight);d-=(h.getBoundingClientRect().height-l.height)*u}this.Preview.parentElement.scrollTo({top:d,left:0,behavior:"smooth"})}else{if(!(s>=0)||!(o>=0))return;{let d=(r-s)/(o-s);if(s=this.getTargetNode(s),!s||(o=this.getTargetNode(o),!o))return;s=s.getBoundingClientRect(),o=o.getBoundingClientRect();let h=o.top+o.height-s.top,u=s.top+h*d-this.Preview.getBoundingClientRect().top,c=this.Editor.parentElement,f=c.scrollHeight>c.offsetHeight?c.scrollTop/(c.scrollHeight-c.offsetHeight):0;u-=c.getBoundingClientRect().height*f,this.Preview.parentElement.scrollTo({top:u,left:0,behavior:"smooth"})}}}}getTargetNode(t){if(!(t>=0))return null;var e=this.Preview.querySelectorAll('span.linenumbermarker[linenumber="'+t+'"]');if(e=[].map.call(e,a=>a),e=e.filter(a=>!a.parentElement.classList.contains("content-link")),e.length===0)return null;var n=this.Preview.parentElement,r=n.getBoundingClientRect().top;return e=e.map(a=>[Math.abs(a.getBoundingClientRect().top-r),a]),e.sort((a,i)=>a[0]-i[0]),e[0][1]}async markupDoc(t){var e=await MarkUp.fullParse(t,{showtitle:!0,classname:"markup-content"});this.Preview.innerHTML=e.content,this.WordCountHint.innerText=e.wordCount,this.title=e.title,this.actionHandler("markupUpdated")}static notTextLine(t,e=!1,n=""){if(t.length===0||!!t.match(/^ *$/))return[!0,!1,n];if(e)return[!0,!0,n];if(t.match(/^\[.+\][:：][ 　\t]*/))return[!0,!0,n];if(n){if(n==="$")return t.match(/^\$\$/)&&(n=""),[!0,e,n];if(n==="`")return t.match(/^```/)&&(n=""),[!0,e,n];if(n==="~")return t.match(/^~~~/)&&(n=""),[!0,e,n]}else{if(t.match(/^((>|\-|\+|\*|\d+)[ 　\t]*)*\$\$/))return[!0,e,"$"];if(t.match(/^((>|\-|\+|\*|\d+)[ 　\t]*)*```/))return[!0,e,"`"];if(t.match(/^((>|\-|\+|\*|\d+)[ 　\t]*)*(~~~$|~~~[ 　\t\w]+)/))return[!0,e,"~"]}return t.match(/^(标题|作者|简介|关键词|更新|GOD|THEONE|TITLE|AUTHOR|EMAIL|DESCRIPTION|STYLE|SCRIPT|DATE|KEYWORD|GLOSSARY|TOC|REF|LINK|IMAGES|VIDEOS|AUDIOS|ARCHOR|SHOWTITLE|SHOWAUTHOR|RESOURCES)[:：]/i)?[!0,e,n]:t.match(/[ 　\t\w\u4e00-\u9fa5]/)?t.match(/[!@#]\[.*\]\(.+\)/)?[!0,e,n]:t.match(/^[ 　\t]*\[.+\][ 　\t]*$/)?[!0,e,n]:t.match(/^\|>.*<\|$/)?[!0,e,n]:[!1,e,n]:[!0,e,n]}static getAllPartsInLine(t,e){var n=[];if(t instanceof RegExp)if(t.global){let r=e.match(t);r&&r.reverse().forEach(a=>{var i=e.lastIndexOf(a);i<0||(n.unshift([i,a]),e=e.substring(0,i))})}else{let r=0;for(;;){let a=e.match(t);if(!a)break;let i=a[0];a=a.index,r+=a,n.push([r,i]),r+=i.length,a+=i.length,e=e.substring(a)}}else for(;;){let r=e.lastIndexOf(t);if(r<0)break;n.unshift([r,t]),e=e.substring(0,r)}return n}}const resizeEditor=(C,t,e,n)=>{var r=document.body.getBoundingClientRect().width,a=!0;if(r<1e3&&(a=!1,C.notAutoUpdateContent=!0,t.parentElement.parentElement.classList.add("no_preview"),n.parentElement.classList.add("no_preview"),console.log(C,t,e,n)),r<=690){let i=C.MenuBar.items.length,s=C.MenuBar.items[i-3];s.ui.style.display="none",s=C.MenuBar.items[i-4],s.ui.style.display="none",s=C.MenuBar.items[i-7],s.ui.style.display="none",s=C.MenuBar.items[i-8],s.ui.style.display="none"}if(r<=580){let i=C.MenuBar.items.length,s=C.MenuBar.items[i-10];s.ui.style.display="none",s=C.MenuBar.items[i-12],s.ui.style.display="none"}if(r<=440){let i=C.MenuBar.items.length,s=C.MenuBar.items[i-15];s.ui.style.display="none"}if(r<=380){let i=C.MenuBar.items.length,s=C.MenuBar.items[i-6];s.ui.style.display="none",s=C.MenuBar.items[i-9],s.ui.style.display="none",s=C.MenuBar.items[i-11],s.ui.style.display="none",s=C.MenuBar.items[i-13],s.ui.style.display="none",s=C.MenuBar.items[i-14],s.ui.style.display="none",s=C.MenuBar.items[i-16],s.ui.style.display="none"}if(a){let i=C.MenuBar.items.length,s=C.MenuBar.items[i-5];s.ui.style.display="none",s=C.MenuBar.items[i-6],s.ui.style.display="none",t.parentElement.parentElement.classList.remove("no_preview"),n.parentElement.classList.remove("no_preview")}};window.initMarkUpEditor=(C,t,e,n,r)=>{var a=new MarkupEditor({ui:{editor:C,toolbar:t,preview:e,wordcount:n},callback:r,shortcuts:Shortcuts,toolbar:MenuConfig}),i=new Map;resizeEditor(a,C,e,n),a.addHandler("markupUpdated",()=>{var d=e.querySelectorAll(".latex");for(let h of d){let u="MATHJAX::"+h.innerText;h._origin=u;let c=i.get(u);c?(h.classList.add("rendered"),h.innerHTML=c):MathJax.Hub.Queue(["Typeset",MathJax.Hub,h])}}),a.addHandler("preview",async()=>{var d=C.parentElement.parentElement;if(d.classList.contains("show_preview"))d.classList.remove("show_preview");else{d.classList.add("show_preview");let h=a.getContent(),u=await MarkUp.fullParse(h,{showtitle:!0,classname:"markup-content"});e.innerHTML=u.content,a.title=u.title,a.actionHandler("markupUpdated")}}),e.addEventListener("click",d=>{d.preventDefault()}),initMathJax.initialized||(initMathJax(),MathJax.Hub.Register.MessageHook("End Process",d=>{var[h,u]=d;if(h==="End Process"&&u!==document.body){var c=(u.innerText||"").toLowerCase();c.length===0||c.indexOf("error")>=0||u._origin&&i.set(u._origin,u.innerHTML)}})),a.actionHandler("init",!1)||a.newFile();var s=document.getSelection(),l=document.createRange(),o=a.Editor.lastChild;return l.setStart(o,0),l.setEnd(o,0),s.removeAllRanges(),s.addRange(l),a};
