(()=>{class j{name="";icon="";key="";shortcut="";ui;container;constructor(h,s,x,C){C=C?C.trim():"",C&&(h=h+"\uFF08"+C+"\uFF09"),this.key=x||s,this.name=h,this.icon=s,this.shortcut=C,this.ui=newEle("div","menu-item"),this.ui.innerHTML='<i class="fa fas far fab fa-'+s+'"></i><span class="menu-item-hint">'+h+"</span>",this.ui.addEventListener("click",()=>{!this.container||this.container.onClick(this.key,this)})}update(h,s,x){var C=this.ui.querySelector("i.fa");C.className="fa fas far fab fa-"+s,this.ui.querySelector("span.menu-item-hint").innerHTML=h,this.key=x,this.name=h,this.icon=s}getShortcuts(){var h={};return this.shortcut&&(h[this.shortcut]=this.key),h}}class L extends j{constructor(){super();this.ui=newEle("div","menu-break-line")}}class H{items=[];name="";icon="";key="";btn;group;ui;container;constructor(){this.btn=new j("","",""),this.btn.container=this,this.group=newEle("div","menu-group-area"),this.ui=newEle("div","menu-group"),this.ui.appendChild(this.btn.ui),this.ui.appendChild(this.group)}add(h,s,x,C){if(h instanceof j)h.container=this,this.items.push(h),this.group.appendChild(h.ui);else if(h instanceof H)h.ui.classList.add("menu-subgroup"),h.container=this,this.items.push(h),this.group.appendChild(h.ui);else{let b=new j(h,s,x,C);b.container=this,this.items.push(b),this.group.appendChild(b.ui)}if(this.items.length===1){let b=this.items[0];this.btn.update(b.name,b.icon,b.key),this.name=b.name,this.icon=b.icon,this.key=b.key}}onClick(h,s){this.btn.update(s.name,s.icon,s.key),this.name=s.name,this.icon=s.icon,this.key=s.key,!!this.container&&this.container.onClick(h,s)}getShortcuts(){var h={};return this.items.forEach(s=>{s=s.getShortcuts(),Object.keys(s).forEach(x=>{x&&(h[x]=s[x])})}),h}}class le{items=[];ui;hooker;constructor(h){this.ui=newEle("div","menu-bar"),this.hooker=h}add(h,s,x,C){if(h instanceof j)h.ui.classList.add("top-level"),this.items.push(h),this.ui.appendChild(h.ui),h.container=this;else if(h instanceof H)this.items.push(h),this.ui.appendChild(h.ui),h.container=this;else{let b=new j(h,s,x,C);b.ui.classList.add("top-level"),this.items.push(b),this.ui.appendChild(b.ui),b.container=this}}onClick(h,s){!this.hooker||this.hooker(h)}getShortcuts(){var h={};return this.items.forEach(s=>{s=s.getShortcuts(),Object.keys(s).forEach(x=>{x&&(h[x]=s[x])})}),h}}class se{content="";startNode=0;startOffset=0;endNode=0;endOffset=0}const N={history:[],index:-1,editor:null,append(A,h,s,x,C){var b=new se;b.content=A,b.startNode=h,b.startOffset=s,b.endNode=x,b.endOffset=C,N.index++,N.history.splice(N.index,N.history.length),N.history.push(b)},restore(){N.index<=0||(N.index--,N.recall())},redo(){N.index!==N.history.length-1&&(N.index++,N.recall())},recall(A){var A=N.history[N.index];if(!!A){N.editor.innerText=A.content;var h=[].map.call(N.editor.childNodes,E=>E),s=h[A.startNode<0?0:A.startNode],x=h[A.endNode>=h.length?h.length-1:A.endNode],C=document.getSelection(),b=C.getRangeAt(0);b.setStart(s,A.startOffset),b.setEnd(x,A.endOffset),C.removeAllRanges(),C.addRange(b),s.tagName==="BR"?s.scrollIntoViewIfNeeded():s.nextElementSibling?s.nextElementSibling.scrollIntoViewIfNeeded():s.previousElementSibling&&s.previousElementSibling.scrollIntoViewIfNeeded()}},clear(){N.index=-1,N.history.splice(0,N.history.length)}},Ae=50,Le=.15,He=["glass","music","search","envelope","heart","star","star-empty","user","film","th-large","th","th-list","ok","remove","zoom-in","zoom-out","off","signal","cog","trash","home","file","time","road","download-alt","download","upload","inbox","play-circle","repeat","refresh","list-alt","lock","flag","headphones","volume-off","volume-down","volume-up","qrcode","barcode","tag","tags","book","bookmark","print","camera","font","bold","italic","text-height","text-width","align-left","align-center","align-right","align-justify","list","indent-left","indent-right","facetime-video","picture","pencil","map-marker","adjust","tint","edit","share","check","move","step-backward","fast-backward","backward","play","pause","stop","forward","fast-forward","step-forward","eject","chevron-left","chevron-right","plus-sign","minus-sign","remove-sign","ok-sign","question-sign","info-sign","screenshot","remove-circle","ok-circle","ban-circle","arrow-left","arrow-right","arrow-up","arrow-down","share-alt","resize-full","resize-small","plus","minus","asterisk","exclamation-sign","gift","leaf","fire","eye-open","eye-close","warning-sign","plane","calendar","random","comment","magnet","chevron-up","chevron-down","retweet","shopping-cart","folder-close","folder-open","resize-vertical","resize-horizontal","bar-chart","twitter-sign","facebook-sign","camera-retro","key","cogs","comments","thumbs-up","thumbs-down","star-half","heart-empty","signout","linkedin-sign","pushpin","external-link","signin","trophy","github-sign","upload-alt","lemon","phone","check-empty","bookmark-empty","phone-sign","twitter","facebook","github","unlock","credit-card","rss","hdd","bullhorn","bell","certificate","hand-right","hand-left","hand-up","hand-down","circle-arrow-left","circle-arrow-right","circle-arrow-up","circle-arrow-down","globe","wrench","tasks","filter","briefcase","fullscreen","group","link","cloud","beaker","cut","copy","paper-clip","save","sign-blank","reorder","list-ul","list-ol","strikethrough","underline","table","magic","truck","pinterest","pinterest-sign","google-plus-sign","google-plus","money","caret-down","caret-up","caret-left","caret-right","columns","sort","sort-down","sort-up","envelope-alt","linkedin","undo","legal","dashboard","comment-alt","comments-alt","bolt","sitemap","umbrella","paste","lightbulb","exchange","cloud-download","cloud-upload","user-md","stethoscope","suitcase","bell-alt","coffee","food","file-alt","building","hospital","ambulance","medkit","fighter-jet","beer","h-sign","plus-sign-alt","double-angle-left","double-angle-right","double-angle-up","double-angle-down","angle-left","angle-right","angle-up","angle-down","desktop","laptop","tablet","mobile-phone","circle-blank","quote-left","quote-right","spinner","circle","reply"],B={};B.Tab="TabIndent",B["shift+Tab"]="TabOutdent",B["ctrl+Tab"]="TabOutdent",B["ctrl+alt+Up"]="blockUp",B["ctrl+alt+Down"]="blockDown",B["ctrl+shift+Up"]="blockUp",B["ctrl+shift+Down"]="blockDown",B["ctrl+D"]="deleteLine",B["ctrl+Z"]="restoreManipulation",B["ctrl+Y"]="redoManipulation";var G="",W="";window.initMarkUpEditor||(window.initMarkUpEditor=(A,h,s,x,C)=>{var b="",E=!1;const l={selection:null,range:null,content:"",texts:[],nodes:[],startNode:null,startOffset:0,endNode:null,endOffset:0,saveRange(){l.selection=document.getSelection(),l.range=l.selection.getRangeAt(0)},restoreRange(){!l.range||(l.selection=document.getSelection(),l.selection.removeAllRanges(),l.selection.addRange(l.range))},update(){l.content=s.innerText,l.nodes=[].map.call(s.childNodes,n=>n),l.texts=l.nodes.filter(n=>n.nodeName==="#text");var e=document.getSelection(),t;if(s!==e.focusNode&&!l.nodes.includes(e.focusNode)?(l.restoreRange(),t=l.range):(l.selection=e,t=e.getRangeAt(0),l.range=t),!!t){if(t.startContainer===s){let n=l.nodes[t.startOffset];if(!n)return;let a=n.nodeName;if(a==="#text")l.startNode=l.nodes[t.startOffset],l.startOffset=0;else if(a==="BR"){let r=l.nodes[t.startOffset+1];if(r)l.startOffset=0;else{if(r=l.nodes[t.startOffset-1],!r)return;l.startOffset=r.textContent.length}l.startNode=r}}else l.startNode=t.startContainer,l.startOffset=t.startOffset;if(t.endContainer===s){let n=l.nodes[t.endOffset];if(!n)return;let a=n.nodeName;if(a==="#text")l.endNode=n,l.endOffset=n.textContent.length;else if(a==="BR"){let r=l.nodes[t.endOffset-1];if(r)l.endOffset=r.textContent.length;else{if(r=l.nodes[t.endOffset+1],!r)return;l.endOffset=0}l.endNode=r}}else l.endNode=t.endContainer,l.endOffset=t.endOffset}},getSurrounding(e="",t=""){t=t||e;var n=l.startNode.textContent;n=n.substring(0,l.startOffset+e.length);var a=n.lastIndexOf(e);if(a>=0&&a<l.startOffset-e.length&&(a=-1),a<0)return[!1,l.startOffset,l.endOffset];n=l.endNode.textContent;var r=Math.max(0,l.endOffset-t.length);n=n.substring(r,n.length);var d=n.indexOf(t);return d>=0&&d>t.length&&(d=-1),d<0?[!1,l.startOffset,l.endOffset]:[!0,a,r+d+t.length]},addPair(e,t,n,a){var r=document.createRange();r.setStart(l.endNode,a),r.setEnd(l.endNode,a),l.selection.removeAllRanges(),l.selection.addRange(r),document.execCommand("insertHTML",!1,t),r=document.createRange(),r.setStart(l.startNode,n),r.setEnd(l.startNode,n),l.selection.removeAllRanges(),l.selection.addRange(r),document.execCommand("insertHTML",!1,e),r=document.createRange(),r.setStart(l.startNode,n),l.startNode===l.endNode?r.setEnd(l.endNode,a+e.length+t.length):r.setEnd(l.endNode,a+t.length),l.selection.removeAllRanges(),l.selection.addRange(r)},removePair(e,t,n,a){var r=l.endNode.textContent,d=r.substring(0,a-t.length),i=r.substring(a,r.length);l.endNode.textContent=d+i,r=l.startNode.textContent,d=r.substring(0,n),i=r.substring(n+e.length,r.length),l.startNode.textContent=d+i;var u=document.createRange();u.setStart(l.startNode,n),l.startNode===l.endNode?u.setEnd(l.endNode,a-e.length-t.length):u.setEnd(l.endNode,a-t.length),l.selection.removeAllRanges(),l.selection.addRange(u)},getSelStruction(){var e=[].map.call(s.childNodes,o=>o),t=e.indexOf(l.startNode),n=e.indexOf(l.endNode),a=t,r=n,d=l.startOffset,i=l.endNode.textContent.length-l.endOffset;for(let o=t;o>=0&&e[o].tagName!=="BR";o--)t=o;for(let o=n;o<e.length&&e[o].tagName!=="BR";o++)n=o;for(let o=t;o<a;o++){let f=e[o];f=f.textContent,d+=f.length}for(let o=r+1;o<=n;o++){let f=e[o];f=f.textContent,i+=f.length}var u=[],g=[];for(let o=t;o<=n;o++){let f=e[o];f.tagName==="BR"?(u.unshift(g),g=[]):g.push([f,o])}return u.unshift(g),u.forEach(o=>{if(!(o.length<2)){var f="";o.forEach(c=>{f+=c[0].textContent}),o[0][0].textContent=f;for(let c=o.length-1;c>0;c--)s.removeChild(o[c][0]);e.splice(o[0][1]+1,o.length-1)}}),u=u.filter(o=>o.length>0),u=u.map(o=>o[0][0]),u.reverse(),i=u.last.textContent.length-i,{nodes:e,selection:{lines:u,start:{node:t,offset:d},end:{node:n,offset:i}}}},rearrangeAll(){var e=[].map.call(s.childNodes,v=>v),t=document.getSelection(),n=t.getRangeAt(0),a=n.startContainer,r=n.endContainer,d=n.startOffset,i=n.endOffset,u=!1;if(a===s){if(a=e[d],!a)return;d=0}if(r===s){if(r=e[i],!r)return;i=0}var g=[],o=[];for(let v=0;v<e.length;v++){let w=e[v];w.tagName==="BR"?(g.push(o),o=[]):o.push(w)}o.length>0&&g.push(o),g=g.filter(v=>v.length>0);var f=!1;if(g.forEach(v=>{if(v.length!==1){f=!0;var w=v[0],O=!1,I=!1,T=-1;if(T=v.indexOf(a),T>=0){T>0&&(u=!0),O=!0,a=w;for(let m=0;m<T;m++)d+=v[m].textContent?.length||0}if(T=v.indexOf(r),T>=0){T>0&&(u=!0),I=!0,r=w;for(let m=0;m<T;m++)i+=v[m].textContent?.length||0}w.textContent=w.wholeText;for(let m=1;m<v.length;m++)s.removeChild(v[m])}}),!e.last.tagName){let v=document.createElement("br");s.appendChild(v),f=!0}f&&(e=[].map.call(s.childNodes,v=>v));var c=e.indexOf(a),p=e.indexOf(r);if(c>p&&([c,p]=[p,c],[a,r]=[r,a],[d,i]=[i,d]),a.tagName==="BR"){let v=e[c-1];!!v&&!v.tagName&&(a=v,c--)}if(r.tagName!=="BR"){let v=e[p+1];!!v&&v.tagName==="BR"&&(r=v,p++)}return{all:e,startNode:a,startIndex:c,startOffset:d,endNode:r,endIndex:p,endOffset:i,selChanged:u}}},R=(e="",t)=>{if(t=t||e,!l.texts.includes(l.startNode)||!l.texts.includes(l.endNode))return!1;var n=l.getSurrounding(e,t);if(!n)return!1;var[a,r,d]=n;return a?l.removePair(e,t,r,d):l.addPair(e,t,r,d),!0},ie=()=>{if(l.selection.isCollapsed||!l.texts.includes(l.startNode)||!l.texts.includes(l.endNode))return!1;var e=5;for(let t=5;t>=2;t--){let n=String.blank(t,"^"),a=l.getSurrounding(n);if(!a)continue;let[r,d,i]=a;if(!!r)return t===5?!1:(l.addPair("^","^",d,i),!0)}return l.addPair("^^","^^",l.startOffset,l.endOffset),!0},oe=()=>{if(l.selection.isCollapsed||!l.texts.includes(l.startNode)||!l.texts.includes(l.endNode))return!1;var e=5;for(let t=5;t>=2;t--){let n=String.blank(t,"^"),a=l.getSurrounding(n);if(!a)continue;let[r,d,i]=a;if(!!r)return t>2?l.removePair("^","^",d,i):l.removePair("^^","^^",d,i),!0}return!1},J=(e,t,n)=>{var a=n[t].textContent;a=String.blank(e,"#")+" "+a,n[t].textContent=a},Q=(e,t,n)=>{if(e)s.removeChild(n[t+1]),s.removeChild(n[t+2]),n.splice(t+1,2);else{let a=n[t].textContent;a=a.replace(/^\#+[ 　\t]*/,""),n[t].textContent=a}},P=(e,t=!1)=>{var n=l.getSelStruction(),a=n.nodes,r=n.selection.start.node,d=n.selection.end.node;if(r!==d)return!1;var i=a[r].textContent.match(/[ 　]*(#+)/),u=!1;if(i?i=i[1].length||0:i=0,i===0){let c=r+2,p=c,v="";for(let w=c;w<a.length;w++){let O=a[w];if(O.tagName==="BR")break;p=w,v=v+O.textContent}if(p>c){a[c].textContent=v;for(let w=c+1;w<=p;w++)s.removeChild(a[w]);a.splice(c+1,p-c)}v.match(/^={3,}$/)?(i=2,u=!0):v.match(/^\-{3,}$/)?(i=1,u=!0):i=0}i===0?J(e,r,a):i===e?Q(u,r,a):(Q(u,r,a),J(e,r,a));var g=a[r],o=document.getSelection(),f=document.createRange();return f.setStart(g,0),f.setEnd(g,g.textContent.length),o.removeAllRanges(),o.addRange(f),!0},_=(e,t=!1)=>{var n=l.getSelStruction(),a=n.selection.lines,r=n.selection.start.offset,d=n.selection.end.offset,i=a.first,u=a.last,g=document.getSelection(),o=document.createRange();return e?i===u&&r===d&&t?(o.setStart(i,r),o.setEnd(i,r),g.removeAllRanges(),g.addRange(o),document.execCommand("insertHTML",!1,"	")):(a.forEach(f=>{f.textContent="	"+f.textContent}),o.setStart(i,0),o.setEnd(u,u.textContent.length),g.removeAllRanges(),g.addRange(o)):(a.forEach(f=>{f.textContent=f.textContent.replace(/^\t/,"")}),o.setStart(i,0),o.setEnd(u,u.textContent.length),g.removeAllRanges(),g.addRange(o)),!0},X=(e=!0)=>{var{all:t,startNode:n,startIndex:a,startOffset:r,endNode:d,endIndex:i,endOffset:u}=l.rearrangeAll();if(e){if(a===0)return changed;let g=!1,o=-1;for(let c=a-1;c>=0;c--)if(t[c].tagName==="BR")if(g){o=c+1;break}else g=!0;let f=t[i+1];for(let c=a-1;c>=o;c--){let p=t[c];s.insertBefore(p,f),f=p}changed=!0}else{if(i===t.length-1)return changed;let g=-1;for(let f=i+1;f<t.length;f++)if(t[f].tagName==="BR"){g=f;break}let o=t[a];for(let f=i+1;f<=g;f++){let c=t[f];s.insertBefore(c,o)}changed=!0}return changed},D=(e,t)=>{var n=l.getSelStruction(),a=n.nodes,r=n.selection.lines,d=e+"	",i=d;t&&(i=i+"["+t+"] ");for(let c=0;c<r.length;c++){let p=c===0?i:d;r[c].textContent=p+r[c].textContent}var u=r.first,g=r.last,o=document.getSelection(),f=document.createRange();return f.setStart(u,0),f.setEnd(g,g.textContent.length),o.removeAllRanges(),o.addRange(f),!0},de=()=>{var{all:e,startNode:t,startIndex:n,startOffset:a,endNode:r,endIndex:d,endOffset:i}=l.rearrangeAll();for(let u=n;u<=d;u++){let g=e[u];s.removeChild(g)}return!0},fe=()=>{var e='<div class="table-generator" style="text-align:center;">';return e+='<div class="table-line">\u884C\uFF1A<input class="number-inputter row-count" type="number" value=2></div>',e+='<div class="table-line">\u5217\uFF1A<input class="number-inputter col-count" type="number" value=2></div>',e+="</div>",showInfobox({title:"\u63D2\u5165\u8868\u683C",mode:"html",content:e,input:!1,action:"oc",callback:(t,n,a)=>{if(l.restoreRange(),t==="ok"){var r=a.$refs.content,d=r.querySelector("input.row-count"),i=r.querySelector("input.col-count");ce(d.value||2,i.value||2)}}}),!1},ce=(e,t)=>{if(!(e<=0||t<=0)){var n=[],a=[];for(let r=1;r<=t;r++)a.push("\u6807\u9898"+r);n.push("|"+a.join("|")+"|"),a=[];for(let r=0;r<t;r++)a.push("-");n.push("|"+a.join("|")+"|");for(let r=0;r<e;r++){a=[];for(let d=0;d<t;d++)a.push("    ");n.push("|"+a.join("|")+"|")}n="<br>"+n.join("<br>")+"<br>",document.execCommand("insertHTML",!1,n),q(!0)}},y=(e,t)=>{l.startNode!==l.endNode&&(l.endNode=l.startNode,l.endOffset=l.startNode.textContent.length),showInfobox({title:"\u63D2\u5165"+e,input:!0,action:"oc",callback:(n,a,r)=>{l.restoreRange(),!(n==="cancel"||!a)&&ue(t,a)}})},ue=(e,t)=>{if(!!t){var n=l.startNode.textContent.substring(l.startOffset,l.endOffset),a="";if(!!n&&n.length>0&&(a="["+n+"]"),e==="footnote"?a+="[:"+t+"]":e==="endnote"?a+="[^"+t+"]":a+="{"+t+"}",document.execCommand("insertHTML",!1,a),e==="anchor")return q(!0);var r="["+t+"]: ",d=newEle("br"),i=document.createTextNode(r);r=r.length,l.startNode.nextSibling?s.insertBefore(i,l.startNode.nextSibling):s.appendChild(i),s.insertBefore(d,i);var u=document.createRange();u.setStart(i,r),u.setEnd(i,r),l.selection.removeAllRanges(),l.selection.addRange(u),q(!0)}},ge=()=>{l.startNode!==l.endNode&&(l.endNode=l.startNode,l.endOffset=l.startNode.textContent.length),showInfobox({title:"\u63D2\u5165 FontAwesome \u56FE\u6807",input:!0,action:"oc",callback:(e,t,n)=>{l.restoreRange(),!(e==="cancel"||!t)&&(document.execCommand("insertHTML",!1," :"+t+": "),q(!0))}})},V=(e,t)=>{var n=l.getSelStruction(),a=n.nodes,r=n.selection.lines,d=n.selection.start.node,i=n.selection.end.node,u=n.selection.start.offset,g=n.selection.end.offset;i!==d&&(i=d,g=r.first.textContent.length,n.selection.end.node=i,n.selection.end.offset=g);var o=r.first.textContent.substring(u,g),f='<div class="link-generator" style="text-align:center;">';return f+='<div class="link-line">\u6807\u9898\uFF1A<input class="number-inputter link-title" value="'+o+'"></div>',f+='<div class="link-line">\u5730\u5740\uFF1A<input class="number-inputter link-address" value=""></div>',t!=="link"&&(f+='<div class="link-line button-line" style="margin-top:10px;font-size:14px;">',f+='<input type="radio" name="position" value="nextline" checked><span class="name">\u72EC\u7ACB\u4E00\u884C</span><br>',f+='<input type="radio" name="position" value="floatleft"><span class="name">\u5DE6\u4FA7\u6DF7\u6392</span><br>',f+='<input type="radio" name="position" value="floatright"><span class="name">\u53F3\u4FA7\u6DF7\u6392</span>',f+="</div>"),f+="</div>",showInfobox({title:"\u63D2\u5165"+e,mode:"html",content:f,input:!1,action:"oc",callback:(c,p,v)=>{if(l.restoreRange(),c==="ok"){var w=v.$refs.content,O=w.querySelector("input.link-title").value,I=w.querySelector("input.link-address").value,T="nextline";w.querySelectorAll('input[type="radio"][name="position"]').forEach(m=>{m.checked&&(T=m.value)}),he(t,O,I,T)}}}),!1},he=(e,t,n,a)=>{if(!(!n||n.length===0)){var r,d=!1;e==="image"?(r="<br>![",d=!0):e==="video"?(r="<br>@[",d=!0):e==="audio"?(r="<br>#[",d=!0):r="[",r+=t+"]("+n,a==="floatleft"?r+=' "left")':a==="floatright"?r+=' "right")':r+=")",d&&(r=r+"<br>");var i=document.getSelection(),u=i.getRangeAt(0),g=u.startContainer,o=u.startOffset;document.execCommand("insertHTML",!1,r);var f=[].map.call(s.childNodes,c=>c);if(d){let c=g.previousSibling?.previousSibling;!!c&&!c.tagName&&(u.setStart(c,0),u.setEnd(c,c.textContent.length),i.removeAllRanges(),i.addRange(u))}else u.setStart(g,o),u.setEnd(g,o+r.length),i.removeAllRanges(),i.addRange(u);q(!0)}},ve=()=>{var e='<div class="table-generator" style="text-align:center;">';return e+='<div class="table-line">\u540D\u79F0\uFF1A<input class="number-inputter block-name" value=""></div>',e+="</div>",showInfobox({title:"\u63D2\u5165\u5F15\u7528\u5757",mode:"html",content:e,input:!1,action:"oc",callback:(t,n,a)=>{if(l.restoreRange(),t==="ok"){var r=a.$refs.content,d=r.querySelector("input.block-name").value;pe(d)}}}),!1},pe=e=>{if(!(!e||e.length===0)){var t="["+e+"]";document.execCommand("insertHTML",!1,t);var n=document.getSelection(),a=n.getRangeAt(0),r=a.startContainer,d=r.textContent.length;a.setStart(r,d),a.setEnd(r,d),n.removeAllRanges(),n.addRange(a),document.execCommand("insertHTML",!1,"<br>[:"+e+":]ref("+e+")[:"+e+":]"),r=r.nextSibling?.nextSibling,!!r&&!r.tagName&&(d=4+e.length,a.setStart(r,d),a.setEnd(r,d+5+e.length),n.removeAllRanges(),n.addRange(a)),q(!0)}},M=e=>{var t=l.getSelStruction(),n=t.nodes,a=t.selection.lines,r=a.first,d=a.last,i=document.getSelection(),u=document.createRange(),g=d.textContent.length;return u.setStart(d,g),u.setEnd(d,g),i.removeAllRanges(),i.addRange(u),document.execCommand("insertHTML",!1,"<br>"+e),u=document.createRange(),u.setStart(r,0),u.setEnd(r,0),i.removeAllRanges(),i.addRange(u),document.execCommand("insertHTML",!1,e+"<br>"),u.setStart(r.previousSibling?.previousSibling,0),u.setEnd(d.nextSibling?.nextSibling,e.length),i.removeAllRanges(),i.addRange(u),!0},U=e=>{var t=l.getSelStruction(),n=t.nodes,a=t.selection.lines,r=t.selection.start.node,d=t.selection.end.node,i=[],u=0,g=[];for(let c=r;c<=d;c++){let p=n[c];p.tagName==="BR"?u++:p.textContent.length>0&&(u>1&&(i.push(g),g=[]),u=0,g.push(p))}g.length>0&&i.push(g),i.forEach(c=>{var p=c.first;p.textContent=p.textContent.replace(/^(( |　|\t|\-|\+|>|\*|~|\d+\.)*(\{[<\|>]\}([ 　\t]*))*)(:*)/,(v,w,O,I,T,m)=>{var F=m.length;return e?m+=":":F>0&&(m=m.substring(1,m.length)),w+m})}),r=a.first,d=a.last;var o=document.getSelection(),f=document.createRange();return f.setStart(r,0),f.setEnd(d,d.textContent.length),o.removeAllRanges(),o.addRange(f),!1},K=e=>{var t=l.getSelStruction(),n=t.nodes,a=t.selection.lines,r=t.selection.start.node,d=t.selection.end.node,i=[],u=0,g=[];for(let c=r;c<=d;c++){let p=n[c];p.tagName==="BR"?u++:p.textContent.length>0&&(u>1&&(i.push(g),g=[]),u=0,g.push(p))}g.length>0&&i.push(g),i.forEach(c=>{var p=c.first;p.textContent=p.textContent.replace(/^(( |　|\t|\-|\+|>|\*|:|~|\d+\.)*)(\{[<\|>]\}([ 　\t]*))+/,(w,O)=>O),p=c.last;var v="";e===0?v=" {<}":e===1?v=" {|}":e===2&&(v=" {>}"),p.textContent=p.textContent.replace(/([ 　\t]*)(\{[<\|>]\}([ 　\t]*))+$/,"")+v}),r=a.first,d=a.last;var o=document.getSelection(),f=document.createRange();return f.setStart(r,0),f.setEnd(d,d.textContent.length),o.removeAllRanges(),o.addRange(f),!1},k=e=>{var t=document.getSelection(),n=t.getRangeAt(0),a=n.startContainer,r=n.startOffset;document.execCommand("insertHTML",!1,"<br><br>"+e+"<br><br>");var d=a.previousSibling?.previousSibling?.previousSibling;return!!d&&!d.tagName&&(n.setStart(d,0),n.setEnd(d,d.textContent.length),t.removeAllRanges(),t.addRange(n)),!0},me=(e,t)=>{var n=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(n),r=document.createElement("a");r.setAttribute("href",a),e?r.setAttribute("download",e):r.setAttribute("download","untitled"),r.click()},be=()=>{var e=l.content,t=G;t||(W?t=W+".mu":t="untitled.mu"),me(t,e)},ee=e=>{G=e.name;var t=new FileReader;t.onload=()=>{s.innerText=t.result,N.clear(),b="",articleConfig={title:e.name,update:e.lastModifiedDate.getTime(),content:t.result,usage:[]},q(!0)},t.readAsText(e)},xe=()=>{var e=C.files[0];!e||ee(e)},te=(e,t=!1)=>{var n=!1;l.update();var a=s.value;if(b!==a&&(E=!0),e==="restoreManipulation")return E=!1,N.restore(),!0;if(e==="redoManipulation")return E=!1,N.redo(),!0;if(e==="TabIndent")n=_(!0,t);else if(e==="TabOutdent")n=_(!1,t);else if(e==="bold")n=R("**");else if(e==="italic")n=R("*");else if(e==="underline")n=R("__");else if(e==="wavy")n=R("~");else if(e==="delete")n=R("~~");else if(e==="sup")n=R("^");else if(e==="sub")n=R("_");else if(e==="sizeUp")n=ie();else if(e==="sizeDown")n=oe();else if(e==="red")n=R("[red]","[/]");else if(e==="green")n=R("[green]","[/]");else if(e==="blue")n=R("[blue]","[/]");else if(e==="yellow")n=R("[yellow]","[/]");else if(e==="gold")n=R("[gold]","[/]");else if(e==="white")n=R("[white]","[/]");else if(e==="silver")n=R("[silver]","[/]");else if(e==="gray")n=R("[gray]","[/]");else if(e==="dark")n=R("[dark]","[/]");else if(e==="black")n=R("[black]","[/]");else{if(e==="insert-icon")return ge(),!1;if(e==="heading-1")n=P(1,t);else if(e==="heading-2")n=P(2,t);else if(e==="heading-3")n=P(3,t);else if(e==="heading-4")n=P(4,t);else if(e==="heading-5")n=P(5,t);else if(e==="heading-6")n=P(6,t);else if(e==="quote-quote")n=D(">");else if(e==="quote-info")n=D(">","info");else if(e==="quote-success")n=D(">","success");else if(e==="quote-warning")n=D(">","warning");else if(e==="quote-danger")n=D(">","danger");else if(e==="list-ol")n=D("1.");else if(e==="list-ul")n=D("-");else if(e==="insert-table")fe(),n=!1;else if(e==="insert-code")n=M("```");else if(e==="insert-latex")n=M("$$");else if(e==="convert-code")n=R("`");else if(e==="convert-latex")n=R("$");else if(e==="footnote")y("\u811A\u6CE8","footnote"),n=!1;else if(e==="endnote")y("\u5C3E\u6CE8","endnote"),n=!1;else if(e==="term")y("\u672F\u8BED","term"),n=!1;else if(e==="anchor")y("\u951A\u70B9","anchor"),n=!1;else if(e==="levelOut")n=_(!1,t);else if(e==="levelIn")n=_(!0,t);else if(e==="blockUp")n=X(!0);else if(e==="blockDown")n=X(!1);else if(e==="indent")n=U(!0);else if(e==="outdent")n=U(!1);else if(e==="align-left")n=K(0);else if(e==="align-center")n=K(1);else if(e==="align-right")n=K(2);else if(e==="insert-link")V("\u8D85\u94FE\u63A5","link"),n=!1;else if(e==="insert-image")V("\u56FE\u7247","image"),n=!1;else if(e==="insert-video")V("\u89C6\u9891","video"),n=!1;else if(e==="insert-audio")V("\u97F3\u9891","audio"),n=!1;else if(e==="headline-normal")n=k("---");else if(e==="headline-double")n=k("===");else if(e==="headline-dotted")n=k("...");else if(e==="headline-dashed")n=k("___");else if(e==="headline-gradient")n=k("+++");else if(e==="headline-wavy")n=k("~~~");else if(e==="headline-star")n=k("***");else if(e==="insert-block")ve(),n=!1;else{if(e==="help")return window.open("/#/markup").focus(),!0;if(e==="close")return A.$router.push({path:"/"}),!0;if(e==="save-article")return be(),!0;if(e==="open-local-article")return C.accept=".mu",C.click(),!0;if(e==="new-article")return G="",W="",s.innerText="",x.innerHTML="",s.focus(),N.clear(),N.append("",0,0,0,0),!0;e==="deleteLine"&&(n=de())}}return n&&q(E),n},S=new le(te);(()=>{var e,t;e=new H,e.add("\u4FDD\u5B58","save","save-article","ctrl+S"),e.add("\u6253\u5F00\u672C\u5730\u6587\u6863","file-word","open-local-article","ctrl+O"),e.add("\u65B0\u5EFA\u7A7A\u6587\u6863","file","new-article","ctrl+N"),S.add(e),S.add(new L),e=new H,e.add("\u52A0\u7C97","bold","bold","ctrl+B"),e.add("\u659C\u4F53","italic","italic","ctrl+I"),e.add("\u4E0B\u5212\u7EBF","underline","underline","alt+U"),e.add("\u6CE2\u6D6A\u7EBF","water","wavy","alt+W"),e.add("\u5220\u9664\u7EBF","strikethrough","delete","alt+D"),e.add(new L),t=new H,t.add("\u7EA2\u8272","color red","red"),t.add("\u7EFF\u8272","color green","green"),t.add("\u84DD\u8272","color blue","blue"),t.add("\u9EC4\u8272","color yellow","yellow"),t.add("\u91D1\u8272","color gold","gold"),t.add("\u767D\u8272","color white","white"),t.add("\u94F6\u8272","color silver","silver"),t.add("\u7070\u8272","color gray","gray"),t.add("\u6DF1\u8272","color dark","dark"),t.add("\u9ED1\u8272","color black","black"),e.add(t),e.add(new L),e.add("\u4E0A\u6807","superscript","sup","alt+P"),e.add("\u4E0B\u6807","subscript","sub","alt+B"),e.add(new L),e.add("\u5927\u4E00\u53F7","sort-amount-up","sizeUp","ctrl+Up"),e.add("\u5C0F\u4E00\u53F7","sort-amount-down","sizeDown","ctrl+Down"),S.add(e),e=new H,e.add("\u811A\u6CE8","paragraph","footnote","alt+F"),e.add("\u5C3E\u6CE8","scroll","endnote","alt+E"),e.add("\u672F\u8BED","pen-nib","term","alt+T"),e.add("\u951A\u70B9","map-pin","anchor","alt+A"),e.add(new L),e.add("\u4EE3\u7801","code","convert-code","alt+C"),e.add("\u516C\u5F0F","square-root-alt","convert-latex","alt+L"),e.add(new L),e.add("\u63D2\u5165\u56FE\u6807","flag","insert-icon"),S.add(e),S.add(new L),e=new H,t=new H,t.add("\u4E00\u7EA7\u6807\u9898","heading one","heading-1","alt+H"),t.add("\u4E8C\u7EA7\u6807\u9898","heading two","heading-2"),t.add("\u4E09\u7EA7\u6807\u9898","heading three","heading-3"),t.add("\u56DB\u7EA7\u6807\u9898","heading four","heading-4"),t.add("\u4E94\u7EA7\u6807\u9898","heading five","heading-5"),t.add("\u516D\u7EA7\u6807\u9898","heading six","heading-6"),e.add(t),e.add(new L),t=new H,t.add("\u666E\u901A\u5F15\u7528","quote-right","quote-quote"),t.add("\u4FE1\u606F\u5F15\u7528","quote-left","quote-info"),t.add("\u63D0\u9192\u5F15\u7528","angle-double-right font green","quote-success"),t.add("\u8B66\u544A\u5F15\u7528","angle-right","quote-warning"),t.add("\u62A5\u9519\u5F15\u7528","angle-double-right font red","quote-danger"),e.add(t),t=new H,t.add("\u65E0\u5E8F\u5217\u8868","list-ul"),t.add("\u6709\u5E8F\u5217\u8868","list-ol"),e.add(t),e.add("\u8868\u683C","table","insert-table"),e.add(new L),e.add("\u4EE3\u7801","code","insert-code"),e.add("\u516C\u5F0F","square-root-alt","insert-latex"),S.add(e),e=new H,e.add("\u5C42\u8FDB","indent","levelIn","ctrl+alt+Right"),e.add("\u5C42\u51FA","outdent","levelOut","ctrl+alt+Left"),e.add(new L),e.add("\u5DE6\u5BF9\u9F50","align-left"),e.add("\u5C45\u4E2D","align-center"),e.add("\u53F3\u5BF9\u9F50","align-right"),e.add(new L),e.add("\u7F29\u8FDB","indent font blue","indent"),e.add("\u9000\u51FA","outdent font blue","outdent"),S.add(e),S.add(new L),e=new H,e.add("\u63D2\u5165\u8D85\u94FE\u63A5","link","insert-link","alt+K"),e.add("\u63D2\u5165\u56FE\u7247","image","insert-image"),e.add("\u63D2\u5165\u89C6\u9891","video","insert-video"),e.add("\u63D2\u5165\u97F3\u9891","music","insert-audio"),S.add(e),e=new H,e.add("\u666E\u901A\u5206\u9694\u7EBF","minus","headline-normal"),e.add("\u53CC\u5C42\u5206\u9694\u7EBF","grip-lines","headline-double"),e.add("\u865A\u7EBF","ellipsis-h","headline-dotted"),e.add("\u70B9\u5212\u7EBF","window-minimize","headline-dashed"),e.add("\u6E10\u53D8\u7EBF","icicles","headline-gradient"),e.add("\u4EA4\u53C9\u7EBF","grip-horizontal","headline-wavy"),e.add("\u5708\u9694\u7EBF","genderless","headline-star"),S.add(e),S.add(new L),S.add("\u63D2\u5165\u5F15\u7528\u5757","vector-square","insert-block"),S.add(new L),S.add("\u5E2E\u52A9\u6587\u6863","info-circle","help","ctrl+H"),S.add(new L),S.add("\u5173\u95ED\u672C\u6587\u6863","times-circle","close");var n=S.getShortcuts();Object.keys(n).forEach(a=>B[a]=n[a]),h.appendChild(S.ui)})();var $,z,Y=[];const we=(e,t=!1,n="")=>{if(e.length===0||!!e.match(/^ *$/))return[!0,!1,n];if(t)return[!0,!0,n];if(e.match(/^\[.+\][:：][ 　\t]*/))return[!0,!0,n];if(n){if(n==="$")return e.match(/^\$\$/)&&(n=""),[!0,t,n];if(n==="`")return e.match(/^```/)&&(n=""),[!0,t,n];if(n==="~")return e.match(/^~~~/)&&(n=""),[!0,t,n]}else{if(e.match(/^\$\$/))return[!0,t,"$"];if(e.match(/^```/))return[!0,t,"`"];if(e.match(/^(~~~$|~~~[ 　\t\w]+)/))return[!0,t,"~"]}return e.match(/^(标题|作者|简介|关键词|更新|GOD|THEONE|TITLE|AUTHOR|EMAIL|DESCRIPTION|STYLE|SCRIPT|DATE|KEYWORD|GLOSSARY|TOC|REF|LINK|IMAGES|VIDEOS|AUDIOS|ARCHOR|SHOWTITLE|SHOWAUTHOR|RESOURCES)[:：]/i)?[!0,t,n]:e.match(/[ 　\t\w\u4e00-\u9fa5]/)?e.match(/[!@#]\[.*\]\(.+\)/)?[!0,t,n]:e.match(/^[ 　\t]*\[.+\][ 　\t]*$/)?[!0,t,n]:e.match(/^\|>.*<\|$/)?[!0,t,n]:[!1,t,n]:[!0,t,n]},Z=e=>{if(!(e>=0))return null;var t=x.querySelectorAll('span.linenumbermarker[linenumber="'+e+'"]');if(t=[].map.call(t,r=>r),t=t.filter(r=>!r.parentElement.classList.contains("content-link")),t.length===0)return null;var n=x.parentElement,a=n.getBoundingClientRect().top;return t=t.map(r=>[Math.abs(r.getBoundingClientRect().top-a),r]),t.sort((r,d)=>r[0]-d[0]),t[0][1]},Ne=e=>{if(e.which===13){let n=document.getSelection(),a=n.getRangeAt(0),r="<br>",d=!0;if(a.collapsed){let f=a.startContainer.wholeText;if(f){let c=f.match(/^([ 　\t>\+\-\*]|\d+\.)*/)||[];c=c[0]||"",c.length>0&&(d=!1),r+=c}}r=r+'<span class="placeholder"></span><br>',document.execCommand("insertHTML",!1,r);let i=s.querySelector("span.placeholder");i.scrollIntoViewIfNeeded();let u=document.createTextNode("test");s.insertBefore(u,i),s.removeChild(i);let g=[].map.call(s.childNodes,f=>f);g.reverse();let o=[];return g.some((f,c)=>{if(f.tagName)return!0;if(f.textContent.length===0){s.removeChild(f),o.push(c);return}return!0}),o.reverse().forEach(f=>g.splice(f,1)),g.reverse(),a=n.getRangeAt(0),n.removeAllRanges(),a=document.createRange(),a.selectNode(u),n.addRange(a),document.execCommand("insertHTML",!1,""),g.last===u&&d&&document.execCommand("insertHTML",!1,"<br><br>"),e.preventDefault(),!1}if(![16,17,18,91].includes(e.which)){E=!0;let n=[];e.ctrlKey&&n.push("ctrl"),e.altKey&&n.push("alt"),e.shiftKey&&n.push("shift"),e.winKey&&n.push("win"),e.metaKey&&n.push("meta");let a=e.key;a.indexOf("Arrow")>=0?a=a.replace("Arrow",""):e.which===27?a="Esc":e.which===8?a="Back":e.which===9?a="Tab":a=a.toUpperCase(),n.push(a),n=n.join("+");var t=B[n];if(!t)return;te(t,!0)&&e.preventDefault()}},ne=e=>{var t=e.dataTransfer;!t||(t=t.files,!!t&&(t=t[0],!!t&&(ee(t),e.preventDefault())))},Ce=e=>{var t=e.clipboardData.getData("text/html"),n=e.clipboardData.files;if(!(t.length===0&&n.length===0)){if(n.length>0&&!!Socket){[].forEach.call(n,o=>{if(!(o.type.indexOf("image")<0)){var f=generateRandomKey(16),c=s.value,p=s.selectionStart,v=s.selectionEnd,w=c.substr(0,p),O=c.substr(v,c.length),I="[\u56FE\u7247("+f+")\u4E0A\u4F20\u4E2D\u2026\u2026]";c=w+`
`+I+`
`+O,p++,v=I.length,s.value=c,s.selectionStart=p,s.selectionEnd=p+v;var T=new FileReader;T.onload=m=>{var F=m.target.result;sendToServer("saveResource",{data:F,id:f,name:o.name,type:o.type})},T.readAsArrayBuffer(o)}}),e.preventDefault();return}var a=newEle("div");a.innerHTML=t;var r=MarkUp.reverse(a);a.innerHTML="",a=null;var t=s.value,d=s.selectionStart,i=s.selectionEnd;r.indexOf(`
`)>=0&&(r=r.replace(/^\n+|\n+$/g,""),d>0&&(r=`

`+r),i<t.length&&(r=r+`

`));var u=t.substr(0,d),g=t.substr(i,t.length);t=u+r+g,d+=r.length,s.value=t,s.selectionStart=d,s.selectionEnd=d,e.preventDefault()}},q=(e=!1)=>{z&&(clearTimeout(z),z=null);var t=s.innerText;if(t=t.replace(/\n*$/gi,""),b!==t){b=t;var n=t;t=t.split(`
`);var a=!1,r="";if(Y.splice(0,Y.length),t=t.map((O,I)=>{var T=!1;if([T,a,r]=we(O,a,r),T)return O;var m=O.match(/^([ 　`~!@#%^&\*\-_\+=\\\|:;\/\?\.,<>\d\r\t]|(\[\w*\][ 　\t]*(\(.*\))*)|\{[\|<>]*\})*/);m?m=m[0]:m="";var F=O.substring(0,m.length),Te=O.substring(m.length,O.length);return m="%LINENUMBER-"+I+"%",Y.push(I),F+m+Te}),t=t.join(`
`),Oe(t),!!e){var d=document.getSelection(),i=d.getRangeAt(0),{all:u,startNode:g,startIndex:o,startOffset:f,endNode:c,endIndex:p,endOffset:v,selChanged:w}=l.rearrangeAll();for(N.append(n,o,f,p-1,v),console.log(g,o,f,c,p,v,w);c.tagName==="BR"&&(c=c.previousSibling,!c););!g||!c||!w||(i.setStart(g,f),i.setEnd(c,v),d.removeAllRanges(),d.addRange(i))}}},Re=()=>{l.saveRange(),re()},re=()=>{var e=s.innerText;e.length===0&&(s.innerHTML="<br/>",s.focus()),z&&(clearTimeout(z),z=null),z=setTimeout(()=>q(E),1e3)},Se=()=>{if($&&(clearTimeout($),$=null),!(s.parentNode.scrollHeight<=s.parentNode.offsetHeight)){var e=s.parentNode.scrollTop/(s.parentNode.scrollHeight-s.parentNode.offsetHeight),t=s.parentNode.getBoundingClientRect();t=t.top+t.height*e;var n=[].map.call(s.childNodes,o=>o),a=-1,r=!0,d=!1;n.some((o,f)=>{if(!o.getBoundingClientRect)return r&&a++,r=!1,d=!0,!1;r?a++:r=!0,d=!1;var c=o.getBoundingClientRect();return c.top>=t}),d||a--;var i,u,g;if(Y.some(o=>{if(o<a&&(i=o),o===a&&(u=o),o>a)return g=o,!0}),u>=0){if(u=Z(u),!u)return;u=u.getBoundingClientRect();let o=u.top-x.getBoundingClientRect().top,f=s.parentElement;if(f.scrollHeight>f.offsetHeight){let c=f.scrollTop/(f.scrollHeight-f.offsetHeight);o-=(f.getBoundingClientRect().height-u.height)*c}x.parentElement.scrollTo({top:o,left:0,behavior:"smooth"})}else{if(!(i>=0)||!(g>=0))return;{let o=(a-i)/(g-i);if(i=Z(i),!i||(g=Z(g),!g))return;i=i.getBoundingClientRect(),g=g.getBoundingClientRect();let f=g.top+g.height-i.top,c=i.top+f*o-x.getBoundingClientRect().top,p=s.parentElement,v=p.scrollHeight>p.offsetHeight?p.scrollTop/(p.scrollHeight-p.offsetHeight):0;c-=p.getBoundingClientRect().height*v,x.parentElement.scrollTo({top:c,left:0,behavior:"smooth"})}}}},ae=()=>{$&&(clearTimeout($),$=null),$=setTimeout(Se,100)},Oe=async e=>{var t=await MarkUp.fullParse(e,{showtitle:!0,classname:"markup-content"});x.innerHTML=t.content,h.uiWordCount.innerText=t.wordCount,W=t.title,await afterMarkUp()};N.editor=s,s.addEventListener("keydown",Ne),s.addEventListener("keyup",re),s.addEventListener("paste",Ce),s.addEventListener("blur",Re),s.parentNode.addEventListener("mousewheel",ae),s.parentNode.addEventListener("scroll",ae),s.addEventListener("drop",ne),x.addEventListener("drop",ne),C.addEventListener("change",xe),document.execCommand("defaultParagraphSeparator",!1,"br"),document.execCommand("insertbronreturn",!1,!0),h.uiWordCount=h.querySelector("div.wordcount-hint span.count")})})();
