(()=>{const OmniOS={};OmniOS.info={name:"OmniOS",version:"0.0.1",author:"LostAbaddon"};const Handlers=new Map,Variables=new Map,Functions=new Map,History=[];History._index=0,History._available=!0;var consoleHistory=[];const initUI=e=>{e._input=newEle("div","inputbox"),e._input._hint=prepareHint(!0),e._input._input=newEle("span","inputter"),e._input._input.contentEditable=!0,e._input._input.addEventListener("keydown",async t=>{if(t.key==="Enter"&&!t.shiftKey){let n=e._input._input.innerText;n=n.replace(/(^[ 　\t\r\n\u00A0]+|[ 　\t\r\n\u00A0]+$)/gi,""),OmniOS.run(n),e._input._input.innerHTML="",e._input._input.focus(),t.preventDefault()}else if(t.key==="ArrowUp"){let n=History.length;if(History._index++,n>=History._index){let i=History[n-History._index];e._input._input.innerText=i;let r=document.getSelection(),s=r.getRangeAt(0),o=e._input._input.childNodes[0];s.setStart(o,o.textContent.length),s.setEnd(o,o.textContent.length),r.addRange(s)}else History._index=n;t.preventDefault()}else if(t.key==="ArrowDown"){let n=History.length;if(History._index--,History._index>0){let i=History[n-History._index];e._input._input.innerText=i;let r=document.getSelection(),s=r.getRangeAt(0),o=e._input._input.childNodes[0];s.setStart(o,o.textContent.length),s.setEnd(o,o.textContent.length),r.addRange(s)}else History._index=0,e._input._input.innerText="";t.preventDefault()}else if(t.key==="Tab"){t.preventDefault();let n=Handlers.get("ontab"),i=document.getSelection(),r=i.getRangeAt(0);if(n){let s=e._input._input.innerText,o=s.substring(0,r.endOffset),l=s.substring(r.endOffset),a=o.split(/[ 　\t]+/),u=a[0];a=a[a.length-1];let d=await n(u,a);if(d){o=o.substring(0,o.length-a.length)+d,a=l.match(/[ 　\t]+/),!!a&&!!a[0]&&(a=l.substring(0,a.index),l=l.replace(a,"")),e._input._input.innerText=o+l;let O=e._input._input.childNodes[0];r.setStart(O,o.length),r.setEnd(O,o.length)}}i.addRange(r)}}),e._input.appendChild(e._input._hint),e._input.appendChild(e._input._input),e.appendChild(e._input),e.addEventListener("mouseup",({target:t})=>{t===e&&e._input._input.focus()})},prepareHint=e=>{var t=newEle("span","hint"),n=":>";if(e)if(n=">:",OmniOS.status.length>0){let i=document.createTextNode(OmniOS.location);t.appendChild(i),i=newEle("span","status"),i.innerText=" ("+OmniOS.status.join("/")+") ",t.appendChild(i),i=document.createTextNode(n),t.appendChild(i)}else t.innerText=OmniOS.location+" "+n;else t.innerText="--"+n;return t},showMessage=(e,t="text")=>{History._available&&consoleHistory.push([e,t,OmniOS.location,[...OmniOS.status]]);var n=newEle("div",["message",t]),i=prepareHint(t==="command");n._hint=i,n.appendChild(i);var r=newEle("span","content");return e.indexOf("<")===0?r.innerHTML=e:r.innerText=e,n._content=r,n.appendChild(r),OmniOS.ui.insertBefore(n,OmniOS.ui._input),OmniOS.ui._input.scrollIntoViewIfNeeded(),n},analyzeParams=e=>{if(e.match(/^"(.|[\r\n])*"$/)){let n;try{n=JSON.parse(e)}catch(r){return console.error(r),null}let i=new Date(n);return i.toString()!=="Invalid Date"?i:n}var t=e*1;return t+""===e?t:(t=e.toLowerCase(),["true","ok"].includes(t)?!0:["false","cancel"].includes(t)?!1:(t=new Date(e),t.toString()!=="Invalid Date"?t:e))},decomposeCmd=e=>{var t=0,n=!1,i={},r=1,s="";e.replace(/(\\*)"/g,(a,u,d)=>{var O=u.length;if(O>>1<<1===O){d+=O;var f=e.substring(t,d+(n?1:0));if(t=d+(n?1:0),n=!n,!!f)if(n)s=s+f;else{let c="%"+r+"%";for(;e.indexOf(c)>=0;)r++,c="%"+r+"%";r++,i[c]=f,s=s+c}}}),t<e.length&&(s+=e.substring(t)),s=s.split(/[ 　\u00A0\t=]+/),s=s.map(a=>i[a]||a),i=[];var o={},l=null;e=s.shift(),s.forEach(a=>{var u=a.replace(/^\-+/,"");if(a===u){let d=l?o[l]:i,O=analyzeParams(a);O!==null&&d.push(O)}else l=u,o[u]=[]});for(let a in o){let u=o[a];u.length===0?o[a]=!0:u.length===1&&(o[a]=u[0])}return{command:e,params:i,options:o}},runCommand=async e=>{if(History._index=0,!!e){History.push(e),showMessage(e,"command");var t=e;e=decomposeCmd(e);var n;if(OmniOS.status.forEach(r=>{var s=Handlers.get(r);if(!!s){var o=s.get(e.command);!o||(n=o)}}),!n){showMessage("\u65E0\u6548\u6307\u4EE4: "+e.command,"error");return}await n(e.params,e.options,t);var i=prepareHint(!0);OmniOS.ui._input._hint.innerHTML=i.innerHTML}},mountOS=async()=>{OmniOS.onCommand("omni","enter",e=>{if(e.length===0){showMessage("\u672A\u6307\u5B9A\u76EE\u6807\u8DEF\u5F84","error");return}if(e=e[0],e.substring(0,1)==="/"&&(OmniOS.location=""),e=e.split(/[\/\\]+/),e=e.filter(n=>!!n),e.length!==0){var t=OmniOS.location.replace(/^\/+|\/+$/g,"").split("/").filter(n=>!!n);e.forEach(n=>{n===".."?t.pop():n!=="."&&t.push(n)}),t.length===0?OmniOS.location="/":OmniOS.location="/"+t.join("/")+"/"}}),OmniOS.onCommand("omni","set",async(e,t,n)=>{var i=e.shift();if(!i){showMessage("\u53D8\u91CF\u540D\u4E3A\u7A7A","error");return}var r=e.shift();if(n=n.replace("set ",""),n=n.replace(i+" ",""),n=n.replace(r+" ",""),r==="is"){let s=e.shift();if(!i){showMessage("\u6307\u4EE4\u540D\u4E3A\u7A7A","error");return}let o=Handlers.get(s);if(!o){showMessage("\u65E0\u6548\u6307\u4EE4: "+s,"error");return}let l=await o(e,t,n);Variables.set(i,l)}else if(r==="as"){let s=e.shift();if(!i){showMessage("\u6307\u4EE4\u540D\u4E3A\u7A7A","error");return}Functions.set(i,[s,e,t,n])}else{showMessage("\u6307\u4EE4\u9519\u8BEF","error");return}}),OmniOS.onCommand("omni","echo",e=>{var t=e.shift();if(!t){showMessage("\u53D8\u91CF\u540D\u4E3A\u7A7A","error");return}if(!Variables.has(t))return showMessage("EMPTY","error"),"EMPTY";var n=Variables.get(t);return showMessage(JSON.stringify(n)),n}),OmniOS.onCommand("omni","exec",async e=>{var t=e.shift();if(!t){showMessage("\u53D8\u91CF\u540D\u4E3A\u7A7A","error");return}if(!Functions.has(t))return showMessage("EMPTY","error"),"EMPTY";var[n,e,i,r]=Functions.get(t),s=Handlers.get(n);if(!s){showMessage("\u65E0\u6548\u6307\u4EE4: "+n,"error");return}var o=await s(e,i,r);return o}),OmniOS.onCommand("omni","eval",async(params,options,raw)=>{raw=raw.replace(/eval[ 　\t\u00A0]*/,"");try{for(let[e,t]of Variables){let n=new RegExp("\\$("+e+")(\\b|$)","g");raw=raw.replace(n,(i,r,s)=>{if(!Variables.has(r))return i;var o=Variables.get(r);return JSON.stringify(o)})}let result=eval(raw);return result===void 0?(showMessage("EMPTY"),result):(showMessage(JSON.stringify(result)),result)}catch(e){console.error(e),showMessage("\u8F93\u5165\u5F0F\u6709\u9519","error")}}),OmniOS.onCommand("omni","clear",async()=>{consoleHistory.splice(0,consoleHistory.length),[].forEach.call(OmniOS.ui.querySelectorAll("div.message"),e=>{OmniOS.ui.removeChild(e)})}),OmniOS.onCommand("omni","commands",async()=>{var e=['<div class="caption">\u53EF\u7528\u547D\u4EE4\u5217\u8868</div>'];OmniOS.status.forEach(t=>{var n=Handlers.get(t);if(!!n){e.push('<div class="caption">'+t+"</div>"),e.push('<div class="content">');for(let[i,r]of n)e.push('<span class="item">'+i+"</span>");e.push("</div>")}}),OmniOS.show(e.join(`
`))})},restoreHistory=()=>{History._available=!1;var e=OmniOS.status,t=OmniOS.location;consoleHistory.forEach(([n,i,r,s])=>{OmniOS.location=r,OmniOS.status=s,showMessage(n,i)}),OmniOS.status=e,OmniOS.location=t,History._available=!0};OmniOS.init=(e,t,n)=>{OmniOS.location=t||"/",OmniOS.status=n||["omni"],OmniOS.ui=e,initUI(e),mountOS(),restoreHistory(),History._available=!1,showMessage("Welcome To Omniverse!","welcome"),History._available=!0,e._input._input.focus()},OmniOS.run=e=>{runCommand(e)},OmniOS.show=(e,t)=>{showMessage(e,t)},OmniOS.onTab=e=>{Handlers.set("ontab",e)},OmniOS.onCommand=(e,t,n,i=!0)=>{var r=Handlers.get(e);r||(r=new Map,Handlers.set(e,r));var s=r.get(t);(!s||i)&&r.set(t,n)},OmniOS.offCommand=(e,t)=>{if(t){let n=Handlers.get(e);if(!n)return;n.delete(t)}else for(let n of Handlers)n[1].delete(e)},OmniOS.turnOn=(...e)=>{e.forEach(n=>{!n||(n=n.replace(/^[ 　\t]+|[ 　\t]+$/g,""),!!n&&(OmniOS.status.includes(n)||OmniOS.status.push(n)))});var t=prepareHint(!0);OmniOS.ui._input._hint.innerHTML=t.innerHTML},OmniOS.turnOff=(...e)=>{e.forEach(n=>{if(!!n&&(n=n.replace(/^[ 　\t]+|[ 　\t]+$/g,""),!!n)){var i=OmniOS.status.indexOf(n);i<0||OmniOS.status.splice(i,1)}});var t=prepareHint(!0);OmniOS.ui._input._hint.innerHTML=t.innerHTML},window.OmniOS=OmniOS})();
